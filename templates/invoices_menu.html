<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoices Menu - Busyman Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .btn .spinner-border {
            margin-left: 8px;
            vertical-align: middle;
        }

        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Horizontal Navigation */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            min-width: 140px;
            text-align: center;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white !important;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .nav-btn.back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .nav-btn.back-btn:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Section Styles */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .client-search-container {
            position: relative;
        }

        #clientSearchResults, #clientSuggestions {
            position: absolute;
            z-index: 1000;
            width: calc(100% - 30px);
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .search-result-item, .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .search-result-item:hover, .suggestion-item:hover{
            background-color: #f5f5f5;
        }

        #clientName.suggesting {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }

        .client-not-found-alert {
            display: none;
            padding: 4px 8px;
            margin-top: 4px;
            border-radius: 3px;
            background-color: transparent;
            color: #dc3545;
            border: none;
            font-size: 0.875rem;
        }

        /* Filter styling */
        .filter-bar {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            background-color: #28a745;
            padding: 12px 16px;
            border-radius: 6px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .filter-item .form-label {
            color: white;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 1rem;
            line-height: 1.4;
        }

        .filter-item .form-control, .filter-item .form-select {
            background-color: white;
            color: #333;
            font-size: 1rem;
            padding: 6px 10px;
            height: 40px;
            line-height: 1.4;
        }

        /* Results styling */
        .scrollable-results {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background-color: #212529;
            color: white;
            z-index: 10;
        }

        .results-count {
            margin-bottom: 10px;
            font-weight: 500;
            color: #495057;
        }

        /* Invoice preview styling */
        #invoicePreview {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            background-color: #f8f9fa;
        }

        .items-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .items-table th {
            background-color: #4472C4;
            color: white;
            padding: 8px;
            text-align: left;
        }

        .items-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .items-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .total-row {
            background-color: #70AD47 !important;
            color: white;
            font-weight: bold;
        }

        /* Field validation styles */
        .form-control.field-error, .form-select.field-error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-control.field-valid, .form-select.field-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .field-error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error-message.show {
            display: block;
        }

        /* Full page loader */
        .full-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loader-content {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.15);
        }

        .editable-field {
            background-color: #90EE90;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .invoice-detail {
            margin-bottom: 10px;
        }

        .invoice-detail label {
            font-weight: bold;
            margin-right: 10px;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-body-scrollable {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Success toast */
        #downloadSuccessToast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }

        /* Section headers */
        .section-header {
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        .section-header h3 {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        /* Mobile responsiveness */
        @media (max-width: 992px) {
            .main-container {
                padding: 0 10px;
            }

            .nav-buttons {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .nav-btn {
                width: 100%;
                max-width: 300px;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .filter-item {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 10px 12px;
            }

            .filter-item .form-label {
                margin-bottom: 0;
                min-width: 80px;
                text-align: left;
                font-size: 0.9rem;
                line-height: 1.5;
                padding-bottom: 2px;
            }

            .filter-item .form-control,
            .filter-item .form-select {
                height: 42px;
                font-size: 0.875rem;
                padding: 10px 12px;
                min-height: 42px;
                box-sizing: border-box;
                line-height: 1.5;
                vertical-align: middle;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 576px) {
            .filter-item {
                padding: 12px 10px;
            }

            .filter-item .form-label {
                min-width: 70px;
                font-size: 0.85rem;
                line-height: 1.6;
                padding-bottom: 3px;
            }

            .filter-item .form-control,
            .filter-item .form-select {
                height: 44px;
                font-size: 16px;
                padding: 12px 12px;
                min-height: 44px;
                line-height: 1.4;
            }
        }
        #clientName::placeholder {
            color: #ccc !important;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Full Page Loader -->
    <div id="fullPageLoader" class="full-page-loader">
        <div class="loader-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading, please wait...</p>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="downloadSuccessToast" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Invoice has been successfully downloaded!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Invoices Menu</h1>
            <!--<p class="text-muted">Create, Edit, and Manage Invoices & Payments</p>-->
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
            <button class="nav-btn active" data-section="create">
                Create
            </button>
            <button class="nav-btn" data-section="edit">
                Edit
            </button>
            <button class="nav-btn" data-section="receive">
                Receive
            </button>
            <a href="/sales" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back
            </a>
        </div>

        <!-- Create Invoice Section -->
        <div id="create-section" class="content-section active">
            <div class="section-header">
                <p>Generate Invoice</p>
            </div>

            <!-- Client Search Section -->
            <div id="clientSearchSection" class="form-section active">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg" id="clientName" placeholder="Type client name...">
                            <button class="btn btn-primary d-flex align-items-center gap-1" type="button" id="searchClientBtn">
                                <i class="bi bi-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="clientNotFoundAlert" class="client-not-found-alert">
                            Client not found. Click "Add New Client" below.
                        </div>
                        <div id="clientSuggestions" class="suggestions-container"></div>
                        <div id="clientSearchResults" class="search-results-container"></div>
                    </div>
                </div>

                <div id="addClientBtnContainer" class="mt-3" style="display: none;">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="bi bi-person-plus me-2"></i>Add New Client
                    </button>
                </div>
            </div>

            <!-- Transaction Type Selection Section -->
            <div id="transactionTypeSection" class="form-section">
                <div class="alert alert-info mb-4">
                   <span id="selectedClientDisplay">No client selected</span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-outline-primary" id="sellBtn">
                                Sell
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="takeBackBtn">
                                Take Back
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-secondary" id="backToClientSearchBtn">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Sales Form Section -->
            <div id="salesFormSection" class="form-section">
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <span id="selectedClientFormDisplay">No client selected</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Invoice No:</strong> <span id="invoiceNumberDisplay"></span>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="invoiceDate" class="form-label">Invoice Date</label>
                        <input type="date" class="form-control" id="invoiceDate">
                    </div>

                    <input type="hidden" id="customerNameDisplay">
                    <input type="hidden" id="invoiceNumber">

                    <div class="col-md-4">
                        <label for="product" class="form-label">Product</label>
                            <select class="form-select" id="product">
                                <option value="">Select a product</option>
                                {% for product in product_names %}
                                    <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            </select>
                    </div>

                    <div class="col-md-4">
                        <label for="quantity" class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                    </div>

                    <div class="col-md-4">
                        <label for="price" class="form-label">Price (KSh) *</label>
                        <input type="number" class="form-control" id="price" step="0.01" min="0">
                    </div>

                    <div class="col-md-4">
                        <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category">
                                <option value=""> Select a Category</option>
                                {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                    </div>

                    <div class="col-md-4">
                        <label for="account" class="form-label">Account Owner</label>
                            <select class="form-select" id="account">
                                <option value=""> Select an Account Owner</option>
                                {% for account in account_owners %}
                                    <option value="{{ account }}">{{ account }}</option>
                                {% endfor %}
                            </select>
                    </div>

                    <div class="col-md-4">
                        <label for="bank_account" class="form-label">Bank Account</label>
                            <select class="form-select" id="bank_account">
                                <option value=""> Select a Bank Account</option>
                                {% for bank_account in bank_accounts %}
                                    <option value="{{ bank_account }}">{{ bank_account }}</option>
                                {% endfor %}
                            </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Transaction Type</label>
                        <input type="text" class="form-control" id="transactionTypeDisplay" readonly>
                    </div>

                    <div class="col-12">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="2" placeholder="Optional notes..."></textarea>
                    </div>

                    <div class="col-12 mt-4">
                        <button type="button" class="btn btn-success me-2" id="saveSaleBtn">
                            <i class="bi bi-save me-2"></i>Save Transaction
                        </button>
                        <div id="saveLoader" class="spinner-border text-primary d-none" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <button type="button" class="btn btn-outline-secondary ms-2" id="backToTransactionTypeBtn">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Add Another Section -->
                <div id="addAnotherSection" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Add another item to this invoice?</h5>
                            <div>
                                <button type="button" class="btn btn-primary me-2" id="addAnotherYesBtn">Yes</button>
                                <button type="button" class="btn btn-success" id="addAnotherNoBtn">No, View invoice</button>
                            </div>
                        </div>
                </div>

                <!-- Invoice Preview -->
                <div id="invoicePreview" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Invoice Preview</h5>
                        <a href="#" class="btn btn-success" id="downloadInvoiceBtn" target="_blank">
                            <i class="bi bi-download me-2"></i>Download Invoice
                        </a>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Invoice Number:</strong> <span id="previewInvoiceNumber"></span></p>
                            <p><strong>Date:</strong> <span id="previewDate"></span></p>
                            <p><strong>Customer:</strong> <span id="previewCustomer"></span></p>
                            <p><strong>Transaction Type:</strong> <span id="previewTransactionType"></span></p>
                        </div>
                    </div>

                    <table class="items-table table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItems">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3"><strong>TOTAL</strong></td>
                                <td><strong>Ksh <span id="previewTotal">0.00</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="pdfLinksContainer" class="mt-3" style="display: none;">
                        <h5>Generated Invoices</h5>
                    <div class="list-group" id="generatedInvoicesList">
                        <!-- PDF links will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Invoices Section -->
        <div id="edit-section" class="content-section">
            <div class="section-header">
                <h3>Invoices</h3>
            </div>

            <form method="POST" action="{{ url_for('invoices_menu') }}" id="editSearchForm">
                <div class="filter-bar">
                    <div class="filter-item">
                        <label for="edit_start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="edit_start_date" name="start_date" value="{{ default_start_date }}">
                    </div>
                    <div class="filter-item">
                        <label for="edit_end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="edit_end_date" name="end_date" value="{{ default_end_date }}">
                    </div>
                    <div class="filter-item">
                        <label for="edit_category" class="form-label">Category</label>
                        <select class="form-control" id="edit_category" name="category">
                            <option value="">All Categories</option>
                                {% for category in categories %}
                            <option value="{{ category }}" {% if request.args.get('category') == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="edit_account_owner" class="form-label">Account Owner</label>
                        <select class="form-control" id="edit_account_owner" name="account_owner">
                            <option value="">All Account Owners</option>
                                {% for account_owner in account_owners %}
                            <option value="{{ account_owner }}" {% if request.args.get('account_owner') == account_owner %}selected{% endif %}>{{ account_owner }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="search-controls">
                        <button type="submit" class="btn btn-primary" id="editSearchBtn">
                            <span id="editSearchText">Search</span>
                            <span id="editSearchSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </form>
            {% if invoices %}
            <div class="invoice-table">
                <p class="results-count">Found {{ invoices|length }} invoices</p>
                <!-- Scrollable Results Container -->
                <div class="scrollable-results">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Invoice Date</th>
                                <th>Customer Name</th>
                                <th>Invoice Number</th>
                                <th>Invoice Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            {% for invoice in invoices %}
                            <tr>
                                <td>{{ invoice[1].strftime('%d-%m-%Y') }}</td>
                                <td>{{ invoice[3] }}</td>
                                <td>{{ invoice[2] }}</td>
                                <td>{{ "Ksh {:,.2f}".format(invoice[7])}}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-info select-btn" data-bs-toggle="modal" data-bs-target="#detailsModal"
                                        data-sales-id="{{ invoice[0] }}"
                                        data-invoice-date="{{ invoice[1].strftime('%Y-%m-%d') }}"
                                        data-invoice-no="{{ invoice[2] }}"
                                        data-customer-name="{{ invoice[3] }}"
                                        data-product="{{ invoice[4] }}"
                                        data-quantity="{{ invoice[5] }}"
                                        data-price="{{ invoice[6] }}"
                                        data-total="{{ invoice[7] }}"
                                        data-category="{{ invoice[8] }}"
                                        data-account-owner="{{ invoice[9] }}"
                                        data-status="{{ invoice[11] }}"
                                        data-bank-account="{{ invoice[12] }}">
                                        Select
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Receive Payments Section -->
        <div id="receive-section" class="content-section">
            <div class="section-header">
                <h3>Receive</h3>
            </div>

            <form id="receiveSearchForm">
                <div class="filter-bar">
                    <div class="filter-item">
                        <label for="receive_start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="receive_start_date" name="start_date">
                    </div>
                    <div class="filter-item">
                        <label for="receive_end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="receive_end_date" name="end_date">
                    </div>
                    <div class="filter-item">
                        <label for="receive_category" class="form-label">Category</label>
                        <select class="form-control" id="receive_category" name="category">
                            <option value="">All Categories</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Books">Books</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="receive_account_owner" class="form-label">Account Owner</label>
                        <select class="form-control" id="receive_account_owner" name="account_owner">
                            <option value="">All Account Owners</option>
                            <option value="John Doe">John Doe</option>
                            <option value="Jane Smith">Jane Smith</option>
                        </select>
                    </div>
                    <div class="search-controls">
                        <button type="button" class="btn btn-primary" id="receiveSearchBtn">
                            <span id="receiveSearchText">Search</span>
                            <span id="receiveSearchSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </form>

            <div id="receive-results-container">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search display-1"></i>
                    <p>Use the filters above to search for sales to receive payments</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal fade" id="addClientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addClientForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row g-3">
                        <div class="col-md-6">
                            <label for="customer_name" class="form-label">Client Name *</label>
                            <input type="text" class="form-control" name="customer_name" id="customer_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="institution" class="form-label">Institution *</label>
                            <input type="text" class="form-control" name="institution" id="institution" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phone_no" class="form-label">Phone No *</label>
                            <input type="number" class="form-control" name="phone_no" id="phone_no" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phone_no_2" class="form-label">Second Phone No</label>
                            <input type="number" class="form-control" name="phone_no_2" id="phone_no_2">
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" id="email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="position" class="form-label">Position</label>
                            <input type="text" class="form-control" name="position" id="position">
                        </div>
                        <div class="col-md-6">
                            <label for="id_no" class="form-label">ID No</label>
                            <input type="text" class="form-control" name="id_no" id="id_no">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Add Client</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="allClientsModal" tabindex="-1" aria-labelledby="allClientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allClientsModalLabel">All Clients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group" id="allClientsList" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    <!-- Invoice Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-scrollable">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Invoice Date:</label>
                                <span id="detail_invoice_date"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Number:</label>
                                <span id="detail_invoice_no"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Customer Name:</label>
                                <span id="detail_customer_name"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Product:</label>
                                <span id="detail_product"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Quantity:</label>
                                <span id="detail_quantity"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Price:</label>
                                <span id="detail_price"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Amount:</label>
                                <span id="detail_total"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Category:</label>
                                <span id="detail_category"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Account Owner:</label>
                                <span id="detail_account_owner"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Bank Account:</label>
                                <span id="detail_bank_account"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Status:</label>
                                <span id="detail_status"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-warning" id="editInvoiceBtn">Edit</button>
                        <button type="button" class="btn btn-danger" id="deleteInvoiceBtn">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm">
                    <div class="modal-body modal-body-scrollable">
                    <input type="hidden" id="modalSalesId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Invoice No</label>
                            <input type="text" class="form-control" name="invoice_no" id="modal_invoice_no" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" name="customer_name" id="modal_customer_name" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Invoice Date</label>
                            <input type="date" class="form-control editable-field" name="invoice_date" id="modal_invoice_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Product</label>
                            <select class="form-control editable-field" name="product" id="modal_product">
                                {% for product in product_names %}
                                <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control editable-field" name="quantity" id="modal_quantity">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control editable-field" name="price" id="modal_price">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select class="form-control editable-field" name="category" id="modal_category">
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Account Owner</label>
                            <select class="form-control editable-field" name="account_owner" id="modal_account_owner">
                                {% for account_owner in account_owners %}
                                <option value="{{ account_owner }}">{{ account_owner }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bank Account</label>
                            <select class="form-control editable-field" name="bank_account" id="modal_bank_account">
                                {% for bank_account in bank_accounts %}
                                <option value="{{ bank_account }}">{{ bank_account }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!--
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <input type="text" class="form-control" name="status" id="modal_status" readonly>
                        </div>
                        -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                        <span id="saveChangesText">Save Changes</span>
                        <span id="saveChangesSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation buttons
            const navButtons = document.querySelectorAll('.nav-btn[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            contentSections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav buttons initially
            navButtons.forEach(btn => btn.classList.remove('active'))

            const savedSection = sessionStorage.getItem('activeSection');
            if (savedSection) {
                document.getElementById(`${savedSection}-section`).classList.add('active');
                document.querySelector(`.nav-btn[data-section="${savedSection}"]`).classList.add('active');
            }

            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    sessionStorage.setItem('activeSection', targetSection);

                    // Update active navigation button
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // Show target section
                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(`${targetSection}-section`).classList.add('active');

                    // Reset create section to client search
                    if (targetSection === 'create') {
                        resetToClientSearch();
                    }
                });
            });

            // Initialize client names array (would be populated from server)
            window.clientNames = {{ client_names|tojson }};

            // Initialize the create invoice functionality
            initializeCreateInvoice();

            // Initialize search functionality for edit and receive sections
            initializeSearchFunctionality();
        });

        // Create Invoice Functionality
        function initializeCreateInvoice() {
            const downloadSuccessToast = new bootstrap.Toast(document.getElementById('downloadSuccessToast'), {autohide: true, delay: 3000});
            const clientNameInput = document.getElementById('clientName');
            const searchClientBtn = document.getElementById('searchClientBtn');
            const clientSearchResults = document.getElementById('clientSearchResults');
            const clientSuggestions = document.getElementById('clientSuggestions');
            const clientSearchSection = document.getElementById('clientSearchSection');
            const transactionTypeSection = document.getElementById('transactionTypeSection');
            const salesFormSection = document.getElementById('salesFormSection');
            const customerNameDisplay = document.getElementById('customerNameDisplay');
            const invoiceNumber = document.getElementById('invoiceNumber');
            const invoiceDate = document.getElementById('invoiceDate');
            const addAnotherSection = document.getElementById('addAnotherSection');
            const addAnotherYesBtn = document.getElementById('addAnotherYesBtn');
            const addAnotherNoBtn = document.getElementById('addAnotherNoBtn');
            const downloadInvoiceBtn = document.getElementById('downloadInvoiceBtn');
            const saveSaleBtn = document.getElementById('saveSaleBtn');
            const sellBtn = document.getElementById('sellBtn');
            const takeBackBtn = document.getElementById('takeBackBtn');
            const transactionTypeDisplay = document.getElementById('transactionTypeDisplay');
            const backToClientSearchBtn = document.getElementById('backToClientSearchBtn');
            const backToTransactionTypeBtn = document.getElementById('backToTransactionTypeBtn');
            const selectedClientDisplay = document.getElementById('selectedClientDisplay');
            const saveLoader = document.getElementById('saveLoader');
            const addClientBtnContainer = document.getElementById('addClientBtnContainer');
            const clientNotFoundAlert = document.getElementById('clientNotFoundAlert');

            // State variables
            let currentItems = [];
            let currentInvoiceUrl = '';
            let currentTransactionType = 'sell';
            function resetToClientSearch() {
                // Reset all sections
                salesFormSection.classList.remove('active');
                transactionTypeSection.classList.remove('active');
                clientSearchSection.classList.add('active');

                //showBackToMenuButton();
                // Reset form
                resetFormForNewItem();
                document.getElementById('account').value = '';
                document.getElementById('bank_account').value = '';
                clientNameInput.value = '';
                selectedClientDisplay.textContent = 'No client selected';

                // Reset state
                currentItems = [];
                currentInvoiceUrl = '';

                // Hide sections
                addAnotherSection.style.display = 'none';
                document.getElementById('invoicePreview').style.display = 'none';
                document.getElementById('pdfLinksContainer').style.display = 'none';

                // Hide add client button and alert
                addClientBtnContainer.style.display = 'none';
                clientNotFoundAlert.style.display = 'none';

                // Show save button
                saveSaleBtn.style.display = 'block';

                // Stop any loading
                stopLoading();
            }
            // Required fields configuration
            const requiredFields = {
                'product': 'Product is required',
                'quantity': 'Quantity is required',
                'price': 'Price is required',
                'category': 'Category is required',
                'account': 'Account Owner is required',
                'bank_account': 'Bank Account is required'
            };

            // Field validation functions
            function validateField(fieldId, value) {
                const field = document.getElementById(fieldId);
                const fieldContainer = field.parentNode;
                let errorElement = fieldContainer.querySelector('.field-error-message');

                // Remove existing validation classes
                field.classList.remove('field-error', 'field-valid');

                if (requiredFields[fieldId]) {
                    if (!value || value.trim() === '') {
                        // Field is empty - show error
                        field.classList.add('field-error');

                        if (!errorElement) {
                            errorElement = document.createElement('div');
                            errorElement.className = 'field-error-message';
                            fieldContainer.appendChild(errorElement);
                        }
                        errorElement.textContent = requiredFields[fieldId];
                        errorElement.classList.add('show');
                        return false;
                    } else {
                        // Field has value - show valid
                        field.classList.add('field-valid');
                        if (errorElement) {
                            errorElement.classList.remove('show');
                        }
                        return true;
                    }
                }
                return true;
            }
            document.getElementById('addClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                fetch('/add_client_ajax', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('clientName').value = data.customer_name;
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
                        modal.hide();
                        alert('Client added successfully!');
                        if (typeof clientNames !== 'undefined') {
                            clientNames.push(data.customer_name);
                        }
                        // Hide the add client button and alert after successful addition
                        document.getElementById('addClientBtnContainer').style.display = 'none';
                        document.getElementById('clientNotFoundAlert').style.display = 'none';
                        selectClient(data.customer_name);
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            });

            function validateAllRequiredFields() {
                let allValid = true;
                const fieldValues = {};

                Object.keys(requiredFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const value = field.value;
                    fieldValues[fieldId] = value;

                    if (!validateField(fieldId, value)) {
                        allValid = false;
                    }
                });

                return { isValid: allValid, values: fieldValues };
            }

            // Add real-time validation listeners
            Object.keys(requiredFields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        validateField(fieldId, this.value);
                    });
                    field.addEventListener('change', function() {
                        validateField(fieldId, this.value);
                    });
                }
            });

            // Client search functionality
            clientNameInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        if (searchTerm.length < 1) {
            clientSuggestions.style.display = 'none';
            clientNameInput.classList.remove('suggesting');
            addClientBtnContainer.style.display = 'none';
            clientNotFoundAlert.style.display = 'none'; // Hide alert when input is empty
            return;
        }

        const filteredClients = clientNames.filter(client =>
            client.toLowerCase().includes(searchTerm)).slice(0, 30);

        if (filteredClients.length > 0) {
            clientSuggestions.innerHTML = '';
            filteredClients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = client;
                item.addEventListener('click', function() {
                    clientNameInput.value = client;
                    clientSuggestions.style.display = 'none';
                    clientNameInput.classList.remove('suggesting');
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none'; // Hide alert when selecting a client
                });
                clientSuggestions.appendChild(item);
            });
            clientSuggestions.style.display = 'block';
            clientNameInput.classList.add('suggesting');
            addClientBtnContainer.style.display = 'none';
            clientNotFoundAlert.style.display = 'none'; // Hide alert when there are suggestions
        } else {
            clientSuggestions.style.display = 'none';
            clientNameInput.classList.remove('suggesting');
            addClientBtnContainer.style.display = 'block';
            clientNotFoundAlert.style.display = 'block'; // Show alert when no suggestions
        }
    });

            document.addEventListener('click', function(e) {
                if (e.target !== clientNameInput && !clientSuggestions.contains(e.target)) {
                    clientSuggestions.style.display = 'none';
                    clientNameInput.classList.remove('suggesting');
                }
            });

            // Search button functionality
            searchClientBtn.addEventListener('click', function() {
                const clientName = clientNameInput.value.trim();

                if (!clientName) {
                    showAllClientsModal();
                    return;
                }

                fetch('/sales/entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=search_client&client_name=${encodeURIComponent(clientName)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'not_found') {
                        // Show the add client button and alert when client is not found
                        addClientBtnContainer.style.display = 'block';
                        clientNotFoundAlert.style.display = 'block';
                        // Don't show alert again as it's already visible from the typing detection
                    } else if (data.status === 'single_result') {
                        addClientBtnContainer.style.display = 'none';
                        clientNotFoundAlert.style.display = 'none'; // Hide alert when client is found
                        selectClient(data.client_name);
                    } else if (data.status === 'multiple_results') {
                        addClientBtnContainer.style.display = 'none';
                        clientNotFoundAlert.style.display = 'none'; // Hide alert when multiple clients found
                        showClientResults(data.clients);
                    }
                })
                .catch(error => {
                    console.error('Error searching client:', error);
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block'; // Show alert on error
                });
            });

            function searchClient(clientName) {
                const filteredClients = window.clientNames.filter(client =>
                    client.toLowerCase().includes(clientName.toLowerCase()));

                if (filteredClients.length === 0) {
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block';
                } else if (filteredClients.length === 1) {
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none';
                    selectClient(filteredClients[0]);
                } else {
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none';
                    showClientResults(filteredClients);
                }
            }

            function showAllClientsModal() {
        const allClientsList = document.getElementById('allClientsList');
        allClientsList.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        const modal = new bootstrap.Modal(document.getElementById('allClientsModal'));
        modal.show();

        if (clientNames && clientNames.length > 0) {
            populateClientList(clientNames);
        } else {
            fetch('/invoices_menu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=get_all_clients'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.clients.length > 0) {
                    populateClientList(data.clients);
                } else {
                    allClientsList.innerHTML = '<div class="list-group-item text-muted">No clients found</div>';
                }
            })
            .catch(error => {
                allClientsList.innerHTML = '<div class="list-group-item text-danger">Error loading clients</div>';
                console.error('Error fetching clients:', error);
            });
        }

        function populateClientList(clients) {
            allClientsList.innerHTML = '';
            clients.sort((a, b) => a.localeCompare(b));

            clients.forEach(client => {
                const clientItem = document.createElement('button');
                clientItem.type = 'button';
                clientItem.className = 'list-group-item list-group-item-action';
                clientItem.textContent = client;
                clientItem.addEventListener('click', function() {
                    selectClient(client);
                    modal.hide();
                });
                allClientsList.appendChild(clientItem);
            });
        }
    }


            function showClientResults(clients) {
                clientSearchResults.innerHTML = '';
                clientSuggestions.style.display = 'none';
                clientNameInput.classList.remove('suggesting');

                if (clients.length === 0) {
                    clientSearchResults.style.display = 'none';
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block';
                    return;
                }

                clients.forEach(client => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = client;
                    item.addEventListener('click', function() {
                        selectClient(client);
                    });
                    clientSearchResults.appendChild(item);
                });

                clientSearchResults.style.display = 'block';
                addClientBtnContainer.style.display = 'none';
                clientNotFoundAlert.style.display = 'none';
            }

            function selectClient(clientName) {
                clientSearchResults.style.display = 'none';
                clientSuggestions.style.display = 'none';
                clientNameInput.classList.remove('suggesting');
                customerNameDisplay.value = clientName;
                selectedClientDisplay.textContent = clientName;
                addClientBtnContainer.style.display = 'none';
                clientNotFoundAlert.style.display = 'none'; // Hide alert when client is selected

                //hideBackToMenuButton();

            fetch('/sales/entry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=select_client&client_name=${encodeURIComponent(clientName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    invoiceNumber.value = data.invoice_number;
                    invoiceDate.value = data.current_date;
                    selectedClientDisplay.innerHTML = `
                        <strong>${data.client_name}</strong>
                        ${data.institution ? `<br><small class="text-muted">${data.institution}</small>` : ''}
                    `;
                    document.getElementById('selectedClientFormDisplay').innerHTML = `
                        <strong>${data.client_name}</strong>
                        ${data.institution ? `<br><small class="text-muted">${data.institution}</small>` : ''}
                    `;
                    document.getElementById('invoiceNumberDisplay').textContent = data.invoice_number;
                    clientSearchSection.classList.remove('active');
                    transactionTypeSection.classList.add('active');
                }
            });
    }

            // Transaction type selection
            sellBtn.addEventListener('click', function() {
                currentTransactionType = 'sell';
                transactionTypeDisplay.value = 'Sell';
                proceedToSalesForm();
            });

            takeBackBtn.addEventListener('click', function() {
                currentTransactionType = 'take_back';
                transactionTypeDisplay.value = 'Take Back';
                proceedToSalesForm();
            });

            function proceedToSalesForm() {
                transactionTypeSection.classList.remove('active');
                salesFormSection.classList.add('active');
            }

            // Navigation buttons
            backToClientSearchBtn.addEventListener('click', function() {
                transactionTypeSection.classList.remove('active');
                clientSearchSection.classList.add('active');
            });

            backToTransactionTypeBtn.addEventListener('click', function() {
                salesFormSection.classList.remove('active');
                transactionTypeSection.classList.add('active');
            });

            function startLoading() {
                saveSaleBtn.disabled = true;
                saveLoader.style.display = 'inline-block';
            }
            function stopLoading() {
                saveSaleBtn.disabled = false;
                saveLoader.style.display = 'none';
            }
            // Save sale functionality
            saveSaleBtn.addEventListener('click', function() {
                // Validate all required fields
                const validation = validateAllRequiredFields();

                if (!validation.isValid) {
                    alert('Please fill in all required fields');
                    return;
                }

                startLoading();

                const formData = {
                    invoice_date: invoiceDate.value,
                    invoice_number: invoiceNumber.value,
                    client_name: customerNameDisplay.value,
                    product: document.getElementById('product').value,
                    quantity: document.getElementById('quantity').value,
                    price: document.getElementById('price').value,
                    category: document.getElementById('category').value,
                    account: document.getElementById('account').value,
                    bank_account: document.getElementById('bank_account').value,
                    notes: document.getElementById('notes').value,
                    transaction_type: currentTransactionType,
                    add_another: 'no'
                };

                fetch('/sales/entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=save_sale&${new URLSearchParams(formData).toString()}`
                })
                .then(response => response.json())
                .then(data => {
                    stopLoading();

                    if (data.status === 'success' || data.status === 'add_another') {
                        const quantity = currentTransactionType === 'take_back' ?
                            -Math.abs(formData.quantity) : formData.quantity;
                        const newItem = {
                            description: formData.product,
                            quantity: quantity,
                            unitPrice: formData.price,
                            total: (quantity * formData.price).toFixed(2),
                            type: currentTransactionType
                        };
                        currentItems.push(newItem);

                        if (data.pdf_urls){
                            showMultiplePdfLinks(data.pdf_urls);
                            currentInvoiceUrl = data.pdf_urls[0].url;
                        } else{
                            currentInvoiceUrl = data.invoice_url;
                        }

                        // Hide save button and show add another section
                        saveSaleBtn.style.display = 'none';
                        addAnotherSection.style.display = 'block';

                        // Don't show preview yet - wait for user decision
                    } else {
                        alert(data.message || 'An error occurred while saving the sale');
                    }
                })
                .catch(error => {
                    stopLoading();
                    console.error('Error saving sale:', error);
                    alert('An error occurred while saving the sale');
                });
            });

            function showMultiplePdfLinks(pdfUrls){
                const pdfLinksContainer = document.getElementById('pdfLinksContainer');
                pdfLinksContainer.innerHTML = '<h6>Generated Invoices:</h6>';

                pdfUrls.forEach(pdf => {
                    const link = document.createElement('a');
                    link.href = pdf.url;
                    link.className = 'd-block mb-2';
                    link.textContent = `Download ${pdf.date} Invoice`;
                    link.target = '_blank';
                    pdfLinksContainer.appendChild(link);
                });

                pdfLinksContainer.style.display = 'block';
            }

            addAnotherYesBtn.addEventListener('click', function() {
                resetFormForNewItem();
                addAnotherSection.style.display = 'none';
                saveSaleBtn.style.display = 'block';
                document.getElementById('product').focus();
            });
            addAnotherNoBtn.addEventListener('click', function() {
                addAnotherSection.style.display = 'none';

                // Now show the invoice preview
                updateInvoicePreview(
                    invoiceNumber.value,
                    invoiceDate.value,
                    customerNameDisplay.value,
                    currentTransactionType,
                    currentItems
                );

                document.getElementById('invoicePreview').style.display = 'block';
            });

            function updateInvoicePreview() {
                document.getElementById('previewInvoiceNumber').textContent = invoiceNumber.value;
                document.getElementById('previewDate').textContent = formatDate(invoiceDate.value);
                document.getElementById('previewCustomer').textContent = customerNameDisplay.value;
                document.getElementById('previewTransactionType').textContent =
                    currentTransactionType === 'sell' ? 'Sale' : 'Take Back';

                const invoiceItems = document.getElementById('invoiceItems');
                invoiceItems.innerHTML = '';
                let totalAmount = 0;

                currentItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.description}</td>
                        <td>${Math.abs(item.quantity)}</td>
                        <td>Ksh ${parseFloat(item.unitPrice).toFixed(2)}</td>
                        <td>Ksh ${parseFloat(item.total).toFixed(2)}</td>
                    `;
                    invoiceItems.appendChild(row);
                    totalAmount += parseFloat(item.total);
                });

                document.getElementById('previewTotal').textContent = totalAmount.toFixed(2);
            }
            downloadInvoiceBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentInvoiceUrl) {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = currentInvoiceUrl;
                    document.body.appendChild(iframe);
                    downloadSuccessToast.show();

                    // Return to client search instead of exiting
                    setTimeout(function() {
                        resetToClientSearch();
                    }, 2000);
                }
            });

            function formatDate(dateString) {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}-${month}-${year}`;
            }

            function resetFormForNewItem() {
                document.getElementById('product').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('price').value = '';
                document.getElementById('category').value = '';
                document.getElementById('notes').value = '';

                Object.keys(requiredFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const fieldContainer = field.parentNode;
                    const errorElement = fieldContainer.querySelector('.field-error-message');

                    field.classList.remove('field-error', 'field-valid');
                    if (errorElement) {
                        errorElement.classList.remove('show');
                    }
                });
            }

        }

        // Search Functionality for Edit and Receive Sections
        function initializeSearchFunctionality() {
            // Edit section search
            document.getElementById('editSearchBtn').addEventListener('click', function() {
                const editSearchForm = document.getElementById('editSearchForm');
                const detailsModal = document.getElementById('detailsModal');
                const editInvoiceBtn = document.getElementById('editInvoiceBtn');
                const deleteInvoiceBtn = document.getElementById('deleteInvoiceBtn');

                let currentInvoiceId = null;

                // Function to load saved filter values
                function loadSavedFilters() {
                    const savedFilters = sessionStorage.getItem('searchFilters');
                    if (savedFilters) {
                        const filters = JSON.parse(savedFilters);

                        // Apply saved values to form fields
                        if (filters.start_date) document.getElementById('edit_start_date').value = filters.start_date;
                        if (filters.end_date) document.getElementById('edit_end_date').value = filters.end_date;
                        if (filters.category) document.getElementById('edit_category').value = filters.category;
                        if (filters.account_owner) document.getElementById('edit_account_owner').value = filters.account_owner;
                    }
                }

                // Function to save current filter values
                function saveFilters() {
                    const formData = new FormData(editSearchForm);
                    const formValues = {};
                    for (let [key, value] of formData.entries()) {
                        formValues[key] = value;
                    }
                    sessionStorage.setItem('searchFilters', JSON.stringify(formValues));
                }

                // Load saved filters when page loads
                loadSavedFilters();

                // Save filters whenever any filter value changes
                const filterInputs = document.querySelectorAll('#editSearchForm input, #searchForm select');
                filterInputs.forEach(input => {
                    input.addEventListener('change', saveFilters);
                    // Also save on input for better responsiveness
                    input.addEventListener('input', saveFilters);
                });

                // Handle form submission
                editSearchForm.addEventListener('submit', function () {
                    const btn = document.getElementById('searchBtn');
                    const text = document.getElementById('searchText');
                    const spinner = document.getElementById('editSearchSpinner');

                    btn.disabled = true;
                    text.textContent = 'Loading...';
                    spinner.classList.remove('d-none');

                    // Save current filters
                    saveFilters();
                });
            });

            detailsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                currentInvoiceId = button.getAttribute('data-sales-id');

                // Populate details modal
                document.getElementById('detail_invoice_date').textContent = button.getAttribute('data-invoice-date');
                document.getElementById('detail_invoice_no').textContent = button.getAttribute('data-invoice-no');
                document.getElementById('detail_customer_name').textContent = button.getAttribute('data-customer-name');
                document.getElementById('detail_product').textContent = button.getAttribute('data-product');
                document.getElementById('detail_quantity').textContent = button.getAttribute('data-quantity');
                document.getElementById('detail_price').textContent = button.getAttribute('data-price');
                document.getElementById('detail_total').textContent = "Ksh " + parseFloat(button.getAttribute('data-total')).toLocaleString('en-KE', {minimumFractionDigits: 2});
                document.getElementById('detail_category').textContent = button.getAttribute('data-category');
                document.getElementById('detail_account_owner').textContent = button.getAttribute('data-account-owner');
                document.getElementById('detail_bank_account').textContent = button.getAttribute('data-bank-account');
                document.getElementById('detail_status').textContent = button.getAttribute('data-status');
            });
            editInvoiceBtn.addEventListener('click', function() {
                // Close details modal
                const detailsModalInstance = bootstrap.Modal.getInstance(detailsModal);
                detailsModalInstance.hide();

                // Open edit modal and populate data
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));

                // Find the select button that was clicked
                const selectButton = document.querySelector(`.select-btn[data-sales-id="${currentInvoiceId}"]`);

                // Populate edit modal
                document.getElementById('modalSalesId').value = currentInvoiceId;
                document.getElementById('modal_invoice_date').value = selectButton.getAttribute('data-invoice-date');
                document.getElementById('modal_invoice_no').value = selectButton.getAttribute('data-invoice-no');
                document.getElementById('modal_customer_name').value = selectButton.getAttribute('data-customer-name');
                document.getElementById('modal_product').value = selectButton.getAttribute('data-product');
                document.getElementById('modal_quantity').value = selectButton.getAttribute('data-quantity');
                document.getElementById('modal_price').value = selectButton.getAttribute('data-price');
                document.getElementById('modal_category').value = selectButton.getAttribute('data-category');
                document.getElementById('modal_account_owner').value = selectButton.getAttribute('data-account-owner');
                document.getElementById('modal_bank_account').value = selectButton.getAttribute('data-bank-account');
                //document.getElementById('modal_status').value = selectButton.getAttribute('data-status');

                editModal.show();
            });
            document.getElementById('editForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const saveBtn = document.getElementById('saveChangesBtn');
                const saveText = document.getElementById('saveChangesText');
                const spinner = document.getElementById('saveChangesSpinner');

                // Show loading state
                saveBtn.disabled = true;
                saveText.textContent = 'Saving...';
                spinner.classList.remove('d-none');

                const salesId = document.getElementById('modalSalesId').value;
                const formData = new FormData(this);
                const payload = Object.fromEntries(formData.entries());

                // Add sales_id to the payload
                payload.sales_id = salesId;

                fetch(`/edit_sale/${salesId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.status === "success") {
                        alert("Invoice updated successfully!");
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                        // Refresh the page to update the results
                        location.reload();
                    } else {
                        alert("Error: " + (data.message || 'Unknown error occurred'));
                    }
                })
                .catch(error => {
                    console.error('Error updating invoice:', error);
                    alert('Error updating invoice');
                })
                .finally(() => {
                    // Reset button state whether success or failure
                    saveBtn.disabled = false;
                    saveText.textContent = 'Save Changes';
                    spinner.classList.add('d-none');
                });
            });

            // Receive section search
            document.getElementById('receiveSearchBtn').addEventListener('click', function() {
                simulateSearch('receive');
            });

            function simulateSearch(section) {
                const spinner = document.getElementById(`${section}SearchSpinner`);
                const text = document.getElementById(`${section}SearchText`);
                const resultsContainer = document.getElementById(`${section}-results-container`);

                // Show loading
                text.textContent = 'Searching...';
                spinner.classList.remove('d-none');
                this.disabled = true;

                // Simulate API call
                setTimeout(() => {
                    // Sample results data
                    const sampleResults = `
                        <div class="results-count">Found 5 invoices</div>
                        <div class="scrollable-results">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Invoice Date</th>
                                        <th>Invoice Number</th>
                                        <th>Customer Name</th>
                                        <th>Invoice Amount</th>
                                        <th>${section === 'receive' ? 'Balance' : 'Actions'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>15-12-2023</td>
                                        <td>INV-001</td>
                                        <td>Client A</td>
                                        <td>Ksh 10,000.00</td>
                                        <td>
                                            ${section === 'receive' ?
                                                'Ksh 5,000.00' :
                                                '<button class="btn btn-sm btn-info">Select</button>'
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>20-12-2023</td>
                                        <td>INV-002</td>
                                        <td>Client B</td>
                                        <td>Ksh 15,000.00</td>
                                        <td>
                                            ${section === 'receive' ?
                                                'Ksh 0.00' :
                                                '<button class="btn btn-sm btn-info">Select</button>'
                                            }
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;

                    resultsContainer.innerHTML = sampleResults;

                    // Reset button
                    text.textContent = 'Search';
                    spinner.classList.add('d-none');
                    this.disabled = false;
                }, 1500);
            }
        }


        // Add Client Form Submission

    </script>
</body>
</html>