<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoices Menu - Busyman Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .btn .spinner-border {
            margin-left: 8px;
            vertical-align: middle;
        }

        #productOptions {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            background: white;
            max-height: 200px;
            overflow-y: auto;
        }

        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: orange;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 36px;
        }

        /* Back button positioning */
        .back-button-container {
            text-align: left;
            margin-bottom: 15px;
        }

        /* Horizontal Navigation */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 0;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 0;
            margin-top: 0;
        }
        #create-section {
            padding: 10px 30px 10px 30px; /* No top padding */
        }
        #edit-section {
            padding: 10px 30px 30px 30px; /* No top padding */
        }
        #receive-section {
            padding: 10px 30px 30px 30px; /* No top padding */
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Section Styles */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .client-search-container {
            position: relative;
        }

        #clientSearchResults, #clientSuggestions {
            position: absolute;
            z-index: 1000;
            width: calc(100% - 30px);
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .search-result-item, .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .search-result-item:hover, .suggestion-item:hover{
            background-color: #f5f5f5;
        }

        #clientName.suggesting {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }

        .client-not-found-alert {
            display: none;
            padding: 4px 8px;
            margin-top: 4px;
            border-radius: 3px;
            background-color: transparent;
            color: #dc3545;
            border: none;
            font-size: 0.875rem;
        }
        .small-form {
            max-width: 500px;
            width: 100%;
            padding: 15px;
        }
        #salesFormSection .form-control {
            font-size: 13.5px;
            color: #6c757d;
        }
        #salesFormSection .form-label {
            font-size: 13.5px;
        }
        #salesFormSection input::placeholder,
        #salesFormSection textarea::placeholder {
            font-size: 13.5px;
        }
        /* Active nav button styling */
        .nav-buttons .btn.active {
            background-color: #000;
            border-color: #000;
            color: white;
        }

        .nav-buttons .btn:hover {
            background-color: #000;
            border-color: #000;
            color: white;
        }
        #actionButtonsContainer {
            animation: fadeIn 0.3s ease-in-out;
            display: none;
        }

        #actionButtonsContainer .btn {
            white-space: nowrap;
            font-size: 0.8rem;
        }

        /* Filter styling */
        .filter-bar {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 0;
            margin-top: 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-item {
            border: 1px solid #376e41;
            padding: 8px 12px;
            border-radius: 6px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .filter-item .form-label {
            color: white;
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        .filter-item .form-control::placeholder {
            color: #376e41 !important;
        }

        .filter-item .form-control, .filter-item .form-select {
            background-color: white;
            color: #376e41;
            font-size: 0.85rem;
            padding: 4px 8px;
            height: 32px;
            line-height: 1.2;
            border: none;
        }

        /* Results styling */
        .scrollable-results {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background-color: #22bf59;
            color: black;
            z-index: 10;
            font-weight: 500;
            font-size: 14px;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 8px 6px;
        }

        .invoice-table {
            margin: 0 auto;
        }

        .table td {
            padding: 8px 6px;
            font-size: 13px;
            vertical-align: top;
            text-align:left;
            white-space: normal;
            word-break: break-word;    /* break long words */
            overflow-wrap: break-word;
        }
        .table td:nth-child(2) {
            max-width: 17ch;        /* adjust as you like */
            white-space: normal;
            width: min-content;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .table td:nth-child(3) {
            max-width: 10ch;        /* adjust as you like */
            width: min-content;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .table {
            border-collapse: collapse;
            table-layout: auto;
            width: 100%; /* or auto if you want shrink */
        }
        .invoice-details {
            display: flex;
            flex-direction: column;
            align-items: left;
            justify-content: flex-start;
            height: 100%;
            white-space: nowrap;
        }

        .results-count {
            margin-bottom: 10px;
            font-weight: 500;
            color: #a2aeba;
            font-size: 12px;
            margin-top: 10px;
        }

        /* Invoice preview styling */
        #invoicePreview {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            background-color: #f8f9fa;
        }

        .items-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .items-table th {
            background-color: #4472C4;
            color: white;
            padding: 8px;
            text-align: left;
        }

        .items-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .items-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .total-row {
            background-color: #70AD47 !important;
            color: white;
            font-weight: bold;
        }

        /* Field validation styles */
        .form-control.field-error, .form-select.field-error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-control.field-valid, .form-select.field-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .field-error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error-message.show {
            display: block;
        }

        /* Full page loader */
        .full-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loader-content {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.15);
        }

        .editable-field {
            background-color: #90EE90;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .invoice-detail {
            margin-bottom: 10px;
        }

        .invoice-detail label {
            font-weight: bold;
            margin-right: 10px;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-body-scrollable {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Success toast */
        #downloadSuccessToast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }

        /* Section headers */
        .section-header {
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        .section-header h3 {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        /* Mobile responsiveness */
        @media (max-width: 992px) {
            .main-container {
                padding: 0 10px;
            }
            #actionButtonsContainer {
                justify-content: flex-end;
                flex-direction: row;
                gap: 8px;
            }

            #actionButtonsContainer .btn {
                flex: 0 0 auto;
                font-size: 0.8rem;
            }

            .filter-bar {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: stretch;
                gap: 6px;

            }

            .filter-item {
                flex-direction: column;
                align-items: left;
                gap: 6px;
                padding: 4px 8px;
                flex: 1 1 calc(50% - 3px);
                min-width: calc(50% - 3px);
                max-width: 100%;
            }

            /* Date filters on same line */
            .filter-item.date-filter {
                flex: 1 1 calc(50% - 3px);
                min-width: calc(50% - 3px);
            }

            /* Other filters full width */
            .filter-item:has(#edit_category),
            .filter-item:has(#edit_account_owner),
            .filter-item:has(#receive_category),
            .filter-item:has(#receive_account_owner) {
                flex: 1 1 calc(50% - 3px);
                min-width: calc(50% - 3px);
            }

            .filter-item .form-label {
                margin-bottom: 0;
                min-width: 50px;
                text-align: left;
                font-size: 0.75rem;
                line-height: 1.1;
                padding-bottom: 0;
                white-space: normal;
            }

            .filter-item .form-control,
            .filter-item .form-select {
                height: 30px;
                font-size: 0.8rem;
                padding: 3px 5px;
                min-height: 28px;
                box-sizing: border-box;
                line-height: 1.1;
                vertical-align: middle;
            }

            .search-controls {
                flex: 1 1 100%;
                display: flex;
                justify-content: flex-end;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 576px) {
            .filter-item {
                padding: 4px 6px;
            }

            .filter-item .form-label {
                min-width: 45px;
                font-size: 0.7rem;
            }

            .filter-item .form-control,
            .filter-item .form-select {
                height: 32px;
                font-size: 0.8rem;
                padding: 4px 6px;
                min-height: 32px;
            }
        }
        #clientName::placeholder {
            color: #ccc !important;
            opacity: 1;
        }
        input[readonly] {
            background-color: #BCB8B1;
            cursor: not-allowed;
        }


        .invoice-details strong {
            font-size: 0.95em;
            color: #2c3e50;
        }

        .invoice-details small {
            font-size: 0.8em;
            color: #6c757d !important;
        }

    </style>
</head>
<body>
    <!-- Full Page Loader -->
    <div id="fullPageLoader" class="full-page-loader">
        <div class="loader-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading, please wait...</p>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="downloadSuccessToast" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Invoice has been successfully downloaded!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div class="main-container">
        <!-- Back Button (above page header) -->
        <div class="back-button-container">
            <a href="/sales" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-2"></i>Back
            </a>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1>Invoice Menu</h1>
            <!--<p class="text-muted">Create, Edit, and Manage Invoices & Payments</p>-->
        </div>

        <!-- Flash Messages -->
        <div id="flash-messages" class="mb-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        </div>

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
            <button class="btn btn-light btn-sm nav-btn" data-section="create">
                Sell
            </button>
            <!--
            <button class="btn btn-outline-primary btn-sm nav-btn" data-section="create">
                Create
            </button>
            -->
            <button class="btn btn-light btn-sm nav-btn" data-section="edit">
                Edit
            </button>
            <button class="btn btn-light btn-sm nav-btn" data-section="receive">
                Receive
            </button>
            <button class="btn btn-light btn-sm nav-btn" data-section="create">
                Returned
            </button>
        </div>

        <!-- Create Invoice Section -->
        <div id="create-section" class="content-section active">
            <!--
            <div class="section-header">
                <p>Generate Invoice</p>
            </div>
            -->

            <!-- Client Search Section -->
            <div id="clientSearchSection" class="form-section active">
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-5 justify-content-center">
                        <div class="input-group">
                            <input type="text" class="form-control" id="clientName" placeholder="Type client name">
                            <button class="btn btn-primary d-flex align-items-center gap-1" type="button" id="searchClientBtn">
                                <i class="bi bi-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="clientNotFoundAlert" class="client-not-found-alert">
                            Client not found. Click "Add New Client" below.
                        </div>
                        <div id="clientSuggestions" class="suggestions-container"></div>
                        <div id="clientSearchResults" class="search-results-container"></div>
                    </div>
                </div>

                <div id="addClientBtnContainer" class="mt-3 text-center" style="display: none;">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="bi bi-person-plus me-2"></i>Add New Client
                    </button>
                </div>
            </div>

            <!-- Transaction Type Selection Section -->
            <div id="transactionTypeSection" class="form-section mx-auto" style="max-width: 400px;">
                <div class="alert alert-info mb-4 text-center">
                   <span id="selectedClientDisplay">No client selected</span>
                </div>
                <div class="row">
                    <div class="col-12 d-flex  justify-content-end">
                        <div class="d-flex gap-2">
                            <!--
                            <button type="button" class="btn btn-outline-primary" id="sellBtn">
                                Sell
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="takeBackBtn">
                                Take Back
                            </button>
                            -->
                            <button type="button" class="btn btn-outline-primary" id="proceedBtn">Proceed</button>
                            <button type="button" class="btn btn-outline-secondary" id="backToClientSearchBtn">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
                <!--
                <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-secondary" id="backToClientSearchBtn">
                        Cancel
                    </button>
                </div>
                -->
            </div>

            <!-- Sales Form Section -->
            <div id="salesFormSection" class="form-section small-form mx-auto">
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <span id="selectedClientFormDisplay">No client selected</span>
                            <br>
                            <span>Inv No: </span><span id="invoiceNumberDisplay"></span>
                        </div>
                        <!--
                        <div class="col-md-6">
                            <span>Inv No: </span><span id="invoiceNumberDisplay"></span>
                        </div>
                        -->
                    </div>
                </div>

                <div class="row g-3">
                    <input type="hidden" id="customerNameDisplay">
                    <input type="hidden" id="invoiceNumber">
                    <div class="col-6 col-md-6">
                        <!--<label for="invoiceDate" class="form-label">Invoice Date</label>-->
                        <!--<label for="invoiceDate" class="form-label"></label>-->
                        <!--<input type="date" class="form-control" id="invoiceDate">-->
                        <input type="text" class="form-control" id="invDate" placeholder="Select Date">
                    </div>

                    <div class="col-6 col-md-6">
                        <!--<label for="account" class="form-label">Account Owner</label>-->
                            <!--<label for="account" class="form-label"></label>-->
                            <select class="form-control" id="account">
                                <option value="">Account Owner</option>
                                {% for account in account_owners %}
                                    <option value="{{ account }}">{{ account }}</option>
                                {% endfor %}
                            </select>
                    </div>

                    <div class="col-6 col-md-6">
                        <!--<label for="product" class="form-label">Product</label>-->
                            <!--<label for="product" class="form-label"></label>-->
                            <select class="form-control" id="product">
                                <option value="">Select Product</option>
                                {% for product in product_names %}
                                    <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            </select>
                    </div>
                    <div class="col-6 col-md-6">
                        <!--<label for="category" class="form-label">Category</label>-->
                            <!--<label for="category" class="form-label"></label>-->
                            <select class="form-control" id="category">
                                <option value=""> Select Category</option>
                                {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                    </div>
                    <div class="col-12">
                       <textarea class="form-control" id="description" rows="2" placeholder="Optional Detailed Description..."></textarea>
                    </div>
                    <div class="col-6 col-md-6 text-center">
                        <label for="quantity" class="form-label">Quantity*</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                    </div>
                    <div class="col-6 col-md-6 text-center">
                        <label for="price" class="form-label">Price (Kes)*</label>
                        <input type="number" class="form-control" id="price" step="0.01" min="0">
                    </div>
                    <div class="col-12">
                        <!--<label for="bank_account" class="form-label">Bank Account</label>-->
                            <!--<label for="bank_account" class="form-label"></label>-->
                            <select class="form-control" id="bank_account">
                                <option value="">Enter Payment Account</option>
                                {% for bank_account in bank_accounts %}
                                    <option value="{{ bank_account }}">{{ bank_account }}</option>
                                {% endfor %}
                            </select>
                    </div>
                    <div class="col-12">
                        <!--<label for="notes" class="form-label">Notes</label>-->
                        <textarea class="form-control" id="notes" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                    <div class="col-12 mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-success" id="saveSaleBtn">
                                <i class="bi bi-save me-2"></i>Save
                            </button>
                            <div class="d-flex align-items-center gap-2">
                                <div id="saveLoader" class="spinner-border text-primary d-none align-self-center" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" id="backToTransactionTypeBtn">
                                    Cancel
                                </button>
                            </div>
                    </div>
                    <!--
                    <div class="col-md-4">
                        <label for="product" class="form-label">Product</label>
                        <label class="form-label" for="product"></label>
                        <div class="position-relative">
                        <input type="text" class="form-control" id="product" list="productOptions" placeholder="Select a Product">
                        <datalist id="productOptions">
                            <option value="">Select a product</option>
                            {% for product in product_names %}
                                <option value="{{ product }}">{{ product }}</option>
                            {% endfor %}
                        </datalist>
                        </div>
                    </div>
                    -->

                    <div class="col-md-4">
                        <!--<label class="form-label">Transaction Type</label>-->
                        <label class="form-label"></label>
                        <input type="text" class="form-control" id="transactionTypeDisplay" hidden>
                    </div>
                </div>

                <!-- Add Another Section -->
                <div id="addAnotherSection" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Add another item to this invoice?</h5>
                            <div>
                                <button type="button" class="btn btn-primary me-2" id="addAnotherYesBtn">Yes</button>
                                <button type="button" class="btn btn-success" id="addAnotherNoBtn">No, View invoice</button>
                            </div>
                        </div>
                </div>

                <!-- Invoice Preview -->
                <div id="invoicePreview" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Invoice Preview</h5>
                        <!--
                        <a href="#" class="btn btn-success" id="downloadInvoiceBtn" target="_blank">
                            <i class="bi bi-download me-2"></i>Download Invoice
                        </a>
                        -->
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Invoice Number:</strong> <span id="previewInvoiceNumber"></span></p>
                            <p><strong>Date:</strong> <span id="previewDate"></span></p>
                            <p><strong>Customer:</strong> <span id="previewCustomer"></span></p>
                            <p><strong>Transaction Type:</strong> <span id="previewTransactionType"></span></p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="items-table table table-bordered">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <!-- Items will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3"><strong>TOTAL</strong></td>
                                    <td><strong>Ksh <span id="previewTotal">0.00</span></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div id="pdfLinksContainer" class="mt-3" style="display: none;">
                        <h5>Generated Invoices</h5>
                    <div class="list-group" id="generatedInvoicesList">
                        <!-- PDF links will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Invoices Section -->
        <div id="edit-section" class="content-section">
            <!--
            <div class="section-header">
                <h3>Invoices</h3>
            </div>
            -->

            <form method="POST" action="{{ url_for('invoices_menu') }}" id="editSearchForm">
                <input type="hidden" name="section" value="edit">
                <div class="filter-bar">
                    <div class="filter-item date-filter">
                        <!--<label for="edit_start_date" class="form-label">Start Date</label>-->
                        <input type="text" class="form-control form-control-sm" id="edit_start_date" name="start_date"  placeholder="Start Date">
                    </div>
                    <div class="filter-item date-filter">
                        <!--<label for="edit_end_date" class="form-label">End Date</label>-->
                        <input type="text" class="form-control form-control-sm" id="edit_end_date" name="end_date" placeholder="End Date">
                    </div>
                    <div class="filter-item">
                      <!--  <label for="edit_category" class="form-label">Category</label> -->
                        <select class="form-control form-control-sm" id="edit_category" name="category">
                            <option value="">Select Category</option>
                                {% for category in categories %}
                            <option value="{{ category }}" {% if request.args.get('category') == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item">
                        <!--<label for="edit_account_owner" class="form-label">Account Owner</label>-->
                        <select class="form-control form-control-sm" id="edit_account_owner" name="account_owner">
                            <option value="">Select Account</option>
                                {% for account_owner in account_owners %}
                            <option value="{{ account_owner }}" {% if request.args.get('account_owner') == account_owner %}selected{% endif %}>{{ account_owner }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="search-controls">
                        <button type="submit" class="btn btn-sm btn-primary" id="editSearchBtn">
                            <span id="editSearchText">Search</span>
                            <span id="editSearchSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </form>
            {% if invoices %}
            <div class="d-flex justify-content-center">
                <div class="invoice-table" style="width: 100%; max-width: 800px;">
                    <p class="results-count">Found {{ invoices|length }} invoices</p>
                    <!-- Scrollable Results Container -->
                    <div class="scrollable-results">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Inv Date/No</th>
                                    <th>Client</th>
                                    <!--<th>Invoice Number</th>-->
                                    <th>Amount (Ksh)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                {% for invoice in invoices %}
                                <tr class="clickable-row"
                                    data-bs-toggle="modal"
                                    data-bs-target="#detailsModal"
                                    data-sales-id="{{ invoice[0] }}"
                                    data-invoice-date="{{ invoice[1].strftime('%Y-%m-%d') }}"
                                    data-invoice-no="{{ invoice[2] }}"
                                    data-customer-name="{{ invoice[3] }}"
                                    data-product="{{ invoice[4] }}"
                                    data-quantity="{{ invoice[5] }}"
                                    data-price="{{ invoice[6] }}"
                                    data-total="{{ invoice[7] }}"
                                    data-category="{{ invoice[8] }}"
                                    data-account-owner="{{ invoice[9] }}"
                                    data-status="{{ invoice[11] }}"
                                    data-bank-account="{{ invoice[12] }}"
                                    style="cursor: pointer;">
                                    <!--<td>{{ invoice[1].strftime('%d-%m-%Y') }}</td>-->
                                    <td>
                                        <div class="invoice-details">
                                            <span>{{ invoice[2] }}</span>
                                            <span>{{ invoice[1].strftime('%d-%m-%Y') }}</span>
                                        </div>
                                    </td>
                                    <td>{{ invoice[3] }}</td>
                                    <!--<td>{{ invoice[2] }}</td>-->
                                    <td>{{ invoice[7] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Receive Payments Section -->
        <div id="receive-section" class="content-section">
            <!--
            <div class="section-header">
                <h3>Receive</h3>
            </div>
            -->

            <form method="POST" action="{{ url_for('invoices_menu') }}" id="receiveSearchForm">
                <input type="hidden" name="section" value="receive">
                <div class="filter-bar">
                    <div class="filter-item date-filter">
                        <!--<label for="receive_start_date" class="form-label">Start Date</label>-->
                        <input type="text" class="form-control form-control-sm" id="receive_start_date" name="start_date"  placeholder="Start Date">
                    </div>
                    <div class="filter-item date-filter">
                        <!--<label for="receive_end_date" class="form-label">End Date</label>-->
                        <input type="text" class="form-control form-control-sm" id="receive_end_date" name="end_date"  placeholder="End Date">
                    </div>
                    <div class="filter-item">
                        <!--<label for="receive_category" class="form-label">Category</label>-->
                        <select class="form-control form-control-sm" id="receive_category" name="category">
                            <option value="">Select Category</option>
                                {% for category in categories %}
                            <option value="{{ category }}" {% if request.args.get('category') == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item">
                        <!--<label for="receive_account_owner" class="form-label">Account Owner</label>-->
                        <select class="form-control form-control-sm" id="receive_account_owner" name="account_owner">
                            <option value="">Select Account</option>
                                {% for account_owner in account_owners %}
                            <option value="{{ account_owner }}" {% if request.args.get('account_owner') == account_owner %}selected{% endif %}>{{ account_owner }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="search-controls">
                        <button type="submit" class="btn btn-sm btn-primary" id="receiveSearchBtn">
                            <span id="receiveSearchText">Search</span>
                            <span id="receiveSearchSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </form>

            {% if sales %}
            <div class="d-flex justify-content-center">
                <div class="invoice-table" style="width: 100%; max-width: 800px;">
                    <p class="results-count">Found {{ sales|length }} invoices</p>

                    <!-- Scrollable Results Container -->
                    <div class="scrollable-results">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Inv No/Date</th>
                                    <!--<th>Invoice Number</th>-->
                                    <th>Client</th>
                                    <th>Balance (Ksh)</th>
                                    <!--<th>Amount</th>-->
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in sales %}
                                <tr class="clickable-row"
                                    data-bs-toggle="modal"
                                    data-bs-target="#receiveDetailsModal"
                                    data-sales-list-id="{{ sale[0] }}"
                                    data-invoice-date="{{ sale[3].strftime('%Y-%m-%d') }}"
                                    data-invoice-no="{{ sale[2] }}"
                                    data-customer-name="{{ sale[1] }}"
                                    data-invoice-amount="{{ sale[4] }}"
                                    data-paid-amount="{{ sale[5] }}"
                                    data-balance="{{ sale[6] }}"
                                    data-reference-no="{{ sale[10] }}"
                                    data-category="{{ sale[8] }}"
                                    data-account-owner="{{ sale[9] }}"
                                    data-status="{{ sale[7] }}"
                                    style="cursor: pointer;">
                                    <td>
                                        <div class="invoice-details">
                                            <span>{{ sale[2] }}</span>
                                            <span>{{ sale[3].strftime('%d-%m-%Y') }}</span>
                                        </div>
                                    </td>
                                    <td>{{ sale[1] }}</td>
                                    <td>{{ sale[6] }}</td>
                                    <!--<td>{{ "Ksh {:,.2f}".format(sale[4])}}</td>-->
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal fade" id="addClientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addClientForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row g-3">
                        <div class="col-md-6">
                            <label for="customer_name" class="form-label">Client Name *</label>
                            <input type="text" class="form-control" name="customer_name" id="customer_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="institution" class="form-label">Institution *</label>
                            <input type="text" class="form-control" name="institution" id="institution" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phone_no" class="form-label">Phone No *</label>
                            <input type="number" class="form-control" name="phone_no" id="phone_no" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phone_no_2" class="form-label">Second Phone No</label>
                            <input type="number" class="form-control" name="phone_no_2" id="phone_no_2">
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" id="email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="position" class="form-label">Position</label>
                            <input type="text" class="form-control" name="position" id="position">
                        </div>
                        <div class="col-md-6">
                            <label for="id_no" class="form-label">ID No</label>
                            <input type="text" class="form-control" name="id_no" id="id_no">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Add Client</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="allClientsModal" tabindex="-1" aria-labelledby="allClientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allClientsModalLabel">All Clients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group" id="allClientsList" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    <!-- Invoice Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-scrollable">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Invoice Date:</label>
                                <span id="detail_invoice_date"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Number:</label>
                                <span id="detail_invoice_no"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Client:</label>
                                <span id="detail_customer_name"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Product:</label>
                                <span id="detail_product"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Quantity:</label>
                                <span id="detail_quantity"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Price:</label>
                                <span id="detail_price"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Amount:</label>
                                <span id="detail_total"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Category:</label>
                                <span id="detail_category"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Account Owner:</label>
                                <span id="detail_account_owner"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Bank Account:</label>
                                <span id="detail_bank_account"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Status:</label>
                                <span id="detail_status"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-warning" id="editInvoiceBtn">Edit</button>
                        <button type="button" class="btn btn-danger" id="deleteInvoiceBtn">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive details modal -->
    <div class="modal fade" id="receiveDetailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-scrollable">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Invoice Date:</label>
                                <span id="receive_detail_invoice_date"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Number:</label>
                                <span id="receive_detail_invoice_no"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Client:</label>
                                <span id="receive_detail_customer_name"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Invoice Amount:</label>
                                <span id="receive_detail_invoice_amount"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="invoice-detail">
                                <label>Paid Amount:</label>
                                <span id="receive_detail_paid_amount"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Balance:</label>
                                <span id="receive_detail_balance"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Category:</label>
                                <span id="receive_detail_category"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Account Owner:</label>
                                <span id="receive_detail_account_owner"></span>
                            </div>
                            <div class="invoice-detail">
                                <label>Status:</label>
                                <span id="receive_detail_status"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-success" id="mpesaInvoiceBtn">MPESA</button>
                        <button type="button" class="btn btn-warning" id="receiveInvoiceBtn">Record</button>
                        <button type="button" class="btn btn-danger" id="deleteSaleBtn">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive Modal -->
    <div class="modal fade" id="receiveModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Receive</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="receiveForm">
                    <div class="modal-body modal-body-scrollable">
                        <input type="hidden" id="modalSalesListId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" name="invoice_date" id="receive_modal_invoice_date" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Invoice No</label>
                                <input type="text" class="form-control" name="invoice_no" id="receive_modal_invoice_no" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Client</label>
                                <input type="text" class="form-control" name="customer_name" id="receive_modal_customer_name" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Invoice Amount</label>
                                <input type="number" class="form-control" name="invoice_amount" id="receive_modal_invoice_amount" readonly>
                            </div>
                            <!--
                            <div class="col-md-6">
                                <label class="form-label">Paid amount</label>
                                <input type="number" step="0.01" min="0" class="form-control editable-field" name="paid_amount" id="receive_modal_paid_amount">
                                <div id="paidAmountError" class="invalid-feedback" style="display: none;">
                                    Paid amount cannot exceed the invoice amount (Ksh <span id="invoiceAmountDisplay">0.00</span>)
                                </div>
                            </div>
                            -->
                            <!--
                            <div class="col-md-6">
                                <label class="form-label" hidden>Amount Paid already</label> -->
                                <input type="number" class="form-control" id="receive_modal_total_paid" hidden>
                            <!--
                            </div>-->

                            <div class="col-md-6">
                                <label class="form-label">Paid amount</label>
                                <input type="number" step="0.01" min="0" class="form-control editable-field"
                                       id="receive_modal_payment_now">
                                <div id="paymentNowError" class="invalid-feedback" style="display: none;">
                                    Payment exceeds remaining balance (Ksh <span id="remainingBalanceDisplay">0.00</span>)
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Balance</label>
                                <input type="number" class="form-control" name="balance" id="receive_modal_balance" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" name="category" id="receive_modal_category" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Account Owner</label>
                                <input type="text" class="form-control" name="account_owner" id="receive_modal_account_owner" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <input type="text" class="form-control" name="status" id="receive_modal_status" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="saveReceiveChangesBtn">
                            <span id="saveReceiveChangesText">Save Changes</span>
                            <span id="saveReceiveChangesSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MPESA Payment Modal -->
<div class="modal fade" id="mpesaModal" tabindex="-1" aria-labelledby="mpesaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mpesaModalLabel">MPESA Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="mpesaPaymentForm">
                <div class="modal-body">
                    <input type="hidden" id="mpesaSalesListId">
                    <input type="hidden" id="mpesaInvoiceNo">
                    <input type="hidden" id="mpesaCustomerName">
                    <input type="hidden" id="mpesaBalance">

                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number *</label>
                        <input type="text" class="form-control" id="phoneNumber"
                               placeholder="2547XXXXXXXX" required pattern="2547\d{8}">
                        <div class="form-text">Format: 2547XXXXXXXX (e.g., 254712345678)</div>
                    </div>

                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (Ksh) *</label>
                        <input type="number" class="form-control" id="amount"
                               min="1" step="1" required>
                    </div>
                    <div id="mpesaResponse" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="initiateStkPush">
                        <span id="stkPushText">Initiate Payment</span>
                        <span id="stkPushSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Invoice Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm">
                    <div class="modal-body modal-body-scrollable">
                    <input type="hidden" id="modalSalesId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Invoice No</label>
                            <input type="text" class="form-control" name="invoice_no" id="modal_invoice_no" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" name="customer_name" id="modal_customer_name" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Invoice Date</label>
                            <input type="date" class="form-control editable-field" name="invoice_date" id="modal_invoice_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Product</label>
                            <select class="form-control editable-field" name="product" id="modal_product">
                                {% for product in product_names %}
                                <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control editable-field" name="quantity" id="modal_quantity">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control editable-field" name="price" id="modal_price">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select class="form-control editable-field" name="category" id="modal_category">
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Account Owner</label>
                            <select class="form-control editable-field" name="account_owner" id="modal_account_owner">
                                {% for account_owner in account_owners %}
                                <option value="{{ account_owner }}">{{ account_owner }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bank Account</label>
                            <select class="form-control editable-field" name="bank_account" id="modal_bank_account">
                                {% for bank_account in bank_accounts %}
                                <option value="{{ bank_account }}">{{ bank_account }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!--
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <input type="text" class="form-control" name="status" id="modal_status" readonly>
                        </div>
                        -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                        <span id="saveChangesText">Save Changes</span>
                        <span id="saveChangesSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script>
        // Initialize Flatpickr
        flatpickr("#edit_start_date",{
            dateFormat: "Y-m-d",
            altFormat: "d-m-Y",
            altInput: true,
            //defaultDate: "{{ default_start_date }}",
            allowInput: true,
            disableMobile: true
        });
        flatpickr("#edit_end_date",{
            dateFormat: "Y-m-d",
            altFormat: "d-m-Y",
            altInput: true,
            //defaultDate: "{{ default_end_date }}",
            allowInput: true,
            disableMobile: true
        });
        flatpickr("#receive_start_date",{
            dateFormat: "Y-m-d",
            altFormat: "d-m-Y",
            altInput: true,
            //defaultDate: "{{ default_start_date }}",
            allowInput: true,
            disableMobile: true
        });
        flatpickr("#receive_end_date",{
            dateFormat: "Y-m-d",
            altFormat: "d-m-Y",
            altInput: true,
            //defaultDate: "{{ default_end_date }}",
            allowInput: true,
            disableMobile: true
        });
        flatpickr("#invDate",{
            dateFormat: "Y-m-d",
            altFormat: "d-m-Y",
            altInput: true,
            //defaultDate: "{{ default_end_date }}",
            allowInput: true,
            disableMobile: true
        });
    </script>

    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation buttons
            const navButtons = document.querySelectorAll('.nav-btn[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            contentSections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav buttons initially
            navButtons.forEach(btn => btn.classList.remove('active'))

            const savedSection = sessionStorage.getItem('activeSection');
            if (savedSection) {
                document.getElementById(`${savedSection}-section`).classList.add('active');
                document.querySelector(`.nav-btn[data-section="${savedSection}"]`).classList.add('active');
            }

            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    const transaction = this.getAttribute('data-transaction'); // sell or take_back
                    sessionStorage.setItem('activeSection', targetSection);

                    // Update active navigation button
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // Show target section
                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(`${targetSection}-section`).classList.add('active');

                    // Reset create section to client search
                    if (targetSection === 'create') {
                        resetToClientSearch();
                        // Auto-set transaction type when coming from nav
                        if (transaction) {
                            currentTransactionType = transaction;
                            document.getElementById('transactionTypeDisplay').value =
                                transaction === 'sell' ? 'Sell' : 'Returned';
                        }
                    }
                });
            });

            // Initialize client names array (would be populated from server)
            window.clientNames = {{ client_names|tojson }};

            // Initialize the create invoice functionality
            initializeCreateInvoice();

            // Initialize search functionality for edit and receive sections
            initializeSearchFunctionality();
        });

        let currentItems = [];
        let currentInvoiceUrl = '';
        let currentTransactionType = 'sell';

        function resetSalesForm() {
            const requiredFields = {
                'product': 'Product is required',
                'quantity': 'Quantity is required',
                'price': 'Price is required',
                'category': 'Category is required',
                'account': 'Account Owner is required',
                'bank_account': 'Bank Account is required'
            };
            // Reset all form fields
            document.getElementById('product').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('price').value = '';
            document.getElementById('category').value = '';
            document.getElementById('account').value = '';
            document.getElementById('bank_account').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('description').value = '';

            const dateInput = document.getElementById('invDate');
            if (dateInput && dateInput._flatpickr) {
                dateInput._flatpickr.clear(); // This is the proper way to clear Flatpickr
            } else {
                dateInput.value = ''; // Fallback
            }

            // Reset validation states
            Object.keys(requiredFields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const fieldContainer = field.parentNode;
                const errorElement = fieldContainer.querySelector('.field-error-message');

                field.classList.remove('field-error', 'field-valid');
                if (errorElement) {
                    errorElement.classList.remove('show');
                }
            });

            currentItems = [];
            currentInvoiceUrl = '';

            // Hide any preview sections
            document.getElementById('invoicePreview').style.display = 'none';
            document.getElementById('pdfLinksContainer').style.display = 'none';

            // Hide action buttons if they exist
            const actionButtonsContainer = document.getElementById('actionButtonsContainer');
            if (actionButtonsContainer) {
                actionButtonsContainer.remove();
            }

            // Ensure save button is visible
            saveSaleBtn.style.display = 'block';
            backToTransactionTypeBtn.style.display = 'block';
        }

        function stopLoading() {
            saveSaleBtn.disabled = false;
            saveLoader.style.display = 'none';
        }

        function resetCurrentItems() {
            currentItems = [];
            currentInvoiceUrl = '';
        }
		function resetToClientSearch() {
		    resetSalesForm();
		    resetCurrentItems();
            // Reset all sections
            salesFormSection.classList.remove('active');
            transactionTypeSection.classList.remove('active');
            clientSearchSection.classList.add('active');

            //showBackToMenuButton();
            document.getElementById('account').value = '';
            document.getElementById('bank_account').value = '';
            //clientNameInput.value = '';
            //selectedClientDisplay.textContent = 'No client selected';

            // Reset state
            currentItems = [];
            currentInvoiceUrl = '';

            const actionButtonsContainer = document.getElementById('actionButtonsContainer');
            if (actionButtonsContainer) {
                actionButtonsContainer.style.display = 'none';
            }

            // Hide sections
            addAnotherSection.style.display = 'none';
            document.getElementById('invoicePreview').style.display = 'none';
            document.getElementById('pdfLinksContainer').style.display = 'none';

            // Hide add client button and alert
            addClientBtnContainer.style.display = 'none';
            clientNotFoundAlert.style.display = 'none';

            // Show save button
            saveSaleBtn.style.display = 'block';

            // Stop any loading
            stopLoading();
        }

        // Create Invoice Functionality
        function initializeCreateInvoice() {
            const downloadSuccessToast = new bootstrap.Toast(document.getElementById('downloadSuccessToast'), {autohide: true, delay: 3000});
            const clientNameInput = document.getElementById('clientName');
            const searchClientBtn = document.getElementById('searchClientBtn');
            const clientSearchResults = document.getElementById('clientSearchResults');
            const clientSuggestions = document.getElementById('clientSuggestions');
            const clientSearchSection = document.getElementById('clientSearchSection');
            const transactionTypeSection = document.getElementById('transactionTypeSection');
            const salesFormSection = document.getElementById('salesFormSection');
            const customerNameDisplay = document.getElementById('customerNameDisplay');
            const invoiceNumber = document.getElementById('invoiceNumber');
            //const invoiceDate = document.getElementById('invoiceDate');
            const addAnotherSection = document.getElementById('addAnotherSection');
            const addAnotherYesBtn = document.getElementById('addAnotherYesBtn');
            const addAnotherNoBtn = document.getElementById('addAnotherNoBtn');
            //const downloadInvoiceBtn = document.getElementById('downloadInvoiceBtn');
            const saveSaleBtn = document.getElementById('saveSaleBtn');
            const sellBtn = document.getElementById('sellBtn');
            const takeBackBtn = document.getElementById('takeBackBtn');
            const transactionTypeDisplay = document.getElementById('transactionTypeDisplay');
            const backToClientSearchBtn = document.getElementById('backToClientSearchBtn');
            const backToTransactionTypeBtn = document.getElementById('backToTransactionTypeBtn');
            const selectedClientDisplay = document.getElementById('selectedClientDisplay');
            const saveLoader = document.getElementById('saveLoader');
            const addClientBtnContainer = document.getElementById('addClientBtnContainer');
            const clientNotFoundAlert = document.getElementById('clientNotFoundAlert');
            const proceedBtn = document.getElementById('proceedBtn');


            // Required fields configuration
            const requiredFields = {
                'product': 'Product is required',
                'quantity': 'Quantity is required',
                'price': 'Price is required',
                'category': 'Category is required',
                'account': 'Account Owner is required',
                'bank_account': 'Bank Account is required'
            };

            // Field validation functions
            function validateField(fieldId, value) {
                const field = document.getElementById(fieldId);
                const fieldContainer = field.parentNode;
                let errorElement = fieldContainer.querySelector('.field-error-message');

                // Remove existing validation classes
                field.classList.remove('field-error', 'field-valid');

                if (requiredFields[fieldId]) {
                    if (!value || value.trim() === '') {
                        // Field is empty - show error
                        field.classList.add('field-error');

                        if (!errorElement) {
                            errorElement = document.createElement('div');
                            errorElement.className = 'field-error-message';
                            fieldContainer.appendChild(errorElement);
                        }
                        errorElement.textContent = requiredFields[fieldId];
                        errorElement.classList.add('show');
                        return false;
                    } else {
                        // Field has value - show valid
                        field.classList.add('field-valid');
                        if (errorElement) {
                            errorElement.classList.remove('show');
                        }
                        return true;
                    }
                }
                return true;
            }

            document.getElementById('addClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                fetch('/add_client_ajax', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('clientName').value = data.customer_name;
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
                        modal.hide();
                        alert('Client added successfully!');
                        if (typeof clientNames !== 'undefined') {
                            clientNames.push(data.customer_name);
                        }
                        // Hide the add client button and alert after successful addition
                        document.getElementById('addClientBtnContainer').style.display = 'none';
                        document.getElementById('clientNotFoundAlert').style.display = 'none';
                        selectClient(data.customer_name);
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            });

            function validateAllRequiredFields() {
                let allValid = true;
                const fieldValues = {};

                Object.keys(requiredFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const value = field.value;
                    fieldValues[fieldId] = value;

                    if (!validateField(fieldId, value)) {
                        allValid = false;
                    }
                });

                return { isValid: allValid, values: fieldValues };
            }

            // Add real-time validation listeners
            Object.keys(requiredFields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        validateField(fieldId, this.value);
                    });
                    field.addEventListener('change', function() {
                        validateField(fieldId, this.value);
                    });
                }
            });

            // Client search functionality
            clientNameInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        if (searchTerm.length < 1) {
            clientSuggestions.style.display = 'none';
            clientNameInput.classList.remove('suggesting');
            addClientBtnContainer.style.display = 'none';
            clientNotFoundAlert.style.display = 'none'; // Hide alert when input is empty
            return;
        }

        const filteredClients = clientNames.filter(client =>
            client.toLowerCase().includes(searchTerm)).slice(0, 30);

        if (filteredClients.length > 0) {
            clientSuggestions.innerHTML = '';
            filteredClients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = client;
                item.addEventListener('click', function() {
                    clientNameInput.value = client;
                    clientSuggestions.style.display = 'none';
                    clientNameInput.classList.remove('suggesting');
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none'; // Hide alert when selecting a client
                });
                clientSuggestions.appendChild(item);
            });
            clientSuggestions.style.display = 'block';
            clientNameInput.classList.add('suggesting');
            addClientBtnContainer.style.display = 'none';
            clientNotFoundAlert.style.display = 'none'; // Hide alert when there are suggestions
        } else {
            clientSuggestions.style.display = 'none';
            clientNameInput.classList.remove('suggesting');
            addClientBtnContainer.style.display = 'block';
            clientNotFoundAlert.style.display = 'block'; // Show alert when no suggestions
        }
    });

            document.addEventListener('click', function(e) {
                if (e.target !== clientNameInput && !clientSuggestions.contains(e.target)) {
                    clientSuggestions.style.display = 'none';
                    clientNameInput.classList.remove('suggesting');
                }
            });

            // Search button functionality
            searchClientBtn.addEventListener('click', function() {
                const clientName = clientNameInput.value.trim();

                if (!clientName) {
                    showAllClientsModal();
                    return;
                }

                fetch('/sales/entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=search_client&client_name=${encodeURIComponent(clientName)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'not_found') {
                        // Show the add client button and alert when client is not found
                        addClientBtnContainer.style.display = 'block';
                        clientNotFoundAlert.style.display = 'block';
                        // Don't show alert again as it's already visible from the typing detection
                    } else if (data.status === 'single_result') {
                        addClientBtnContainer.style.display = 'none';
                        clientNotFoundAlert.style.display = 'none'; // Hide alert when client is found
                        selectClient(data.client_name);
                    } else if (data.status === 'multiple_results') {
                        addClientBtnContainer.style.display = 'none';
                        clientNotFoundAlert.style.display = 'none'; // Hide alert when multiple clients found
                        showClientResults(data.clients);
                    }
                })
                .catch(error => {
                    console.error('Error searching client:', error);
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block'; // Show alert on error
                });
            });

            function searchClient(clientName) {
                const filteredClients = window.clientNames.filter(client =>
                    client.toLowerCase().includes(clientName.toLowerCase()));

                if (filteredClients.length === 0) {
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block';
                } else if (filteredClients.length === 1) {
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none';
                    selectClient(filteredClients[0]);
                } else {
                    addClientBtnContainer.style.display = 'none';
                    clientNotFoundAlert.style.display = 'none';
                    showClientResults(filteredClients);
                }
            }

            function showAllClientsModal() {
        const allClientsList = document.getElementById('allClientsList');
        allClientsList.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        const modal = new bootstrap.Modal(document.getElementById('allClientsModal'));
        modal.show();

        if (clientNames && clientNames.length > 0) {
            populateClientList(clientNames);
        } else {
            fetch('/invoices_menu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=get_all_clients'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.clients.length > 0) {
                    populateClientList(data.clients);
                } else {
                    allClientsList.innerHTML = '<div class="list-group-item text-muted">No clients found</div>';
                }
            })
            .catch(error => {
                allClientsList.innerHTML = '<div class="list-group-item text-danger">Error loading clients</div>';
                console.error('Error fetching clients:', error);
            });
        }

        function populateClientList(clients) {
            allClientsList.innerHTML = '';
            clients.sort((a, b) => a.localeCompare(b));

            clients.forEach(client => {
                const clientItem = document.createElement('button');
                clientItem.type = 'button';
                clientItem.className = 'list-group-item list-group-item-action';
                clientItem.textContent = client;
                clientItem.addEventListener('click', function() {
                    selectClient(client);
                    modal.hide();
                });
                allClientsList.appendChild(clientItem);
            });
        }
    }


            function showClientResults(clients) {
                clientSearchResults.innerHTML = '';
                clientSuggestions.style.display = 'none';
                clientNameInput.classList.remove('suggesting');

                if (clients.length === 0) {
                    clientSearchResults.style.display = 'none';
                    addClientBtnContainer.style.display = 'block';
                    clientNotFoundAlert.style.display = 'block';
                    return;
                }

                clients.forEach(client => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = client;
                    item.addEventListener('click', function() {
                        selectClient(client);
                    });
                    clientSearchResults.appendChild(item);
                });

                clientSearchResults.style.display = 'block';
                addClientBtnContainer.style.display = 'none';
                clientNotFoundAlert.style.display = 'none';
            }

            function selectClient(clientName) {
                clientSearchResults.style.display = 'none';
                clientSuggestions.style.display = 'none';
                clientNameInput.classList.remove('suggesting');
                customerNameDisplay.value = clientName;
                selectedClientDisplay.textContent = clientName;
                addClientBtnContainer.style.display = 'none';
                clientNotFoundAlert.style.display = 'none'; // Hide alert when client is selected

                //hideBackToMenuButton();

            fetch('/sales/entry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=select_client&client_name=${encodeURIComponent(clientName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    invoiceNumber.value = data.invoice_number;
                    //invoiceDate.value = data.current_date;
                    selectedClientDisplay.innerHTML = `
                        <strong>${data.client_name}</strong>
                        ${data.institution ? `<br><small class="text-muted">${data.institution}</small>` : ''}
                    `;
                    document.getElementById('selectedClientFormDisplay').innerHTML = `
                        <strong>${data.client_name}</strong>
                        ${data.institution ? `<br><small class="text-muted">${data.institution}</small>` : ''}
                    `;
                    document.getElementById('invoiceNumberDisplay').textContent = data.invoice_number;
                    clientSearchSection.classList.remove('active');
                    transactionTypeSection.classList.add('active');
                }
            });
    }

            // Transaction type selection
            //sellBtn.addEventListener('click', function() {
              //  currentTransactionType = 'sell';
                //transactionTypeDisplay.value = 'Sell';
                //proceedToSalesForm();
            //});

            //takeBackBtn.addEventListener('click', function() {
              //  currentTransactionType = 'take_back';
                //transactionTypeDisplay.value = 'Take Back';
                //proceedToSalesForm();
            //});
            proceedBtn.addEventListener('click', function() {
                transactionTypeSection.classList.remove('active');
                salesFormSection.classList.add('active');
            });
            function proceedToSalesForm() {
                transactionTypeSection.classList.remove('active');
                salesFormSection.classList.add('active');
            }

            // Navigation buttons
            backToClientSearchBtn.addEventListener('click', function() {
                resetSalesForm();
                transactionTypeSection.classList.remove('active');
                clientSearchSection.classList.add('active');
            });

            backToTransactionTypeBtn.addEventListener('click', function() {
                resetSalesForm();
                salesFormSection.classList.remove('active');
                transactionTypeSection.classList.add('active');
            });

            function startLoading() {
                saveSaleBtn.disabled = true;
                saveLoader.style.display = 'inline-block';
            }
            function stopLoading() {
                saveSaleBtn.disabled = false;
                saveLoader.style.display = 'none';
            }
            // Save sale functionality
            saveSaleBtn.addEventListener('click', function() {
                // Validate all required fields
                const validation = validateAllRequiredFields();

                if (!validation.isValid) {
                    alert('Please fill in all required fields');
                    return;
                }

                startLoading();

                const formData = {
                    invoice_date: invDate.value,
                    invoice_number: invoiceNumber.value,
                    client_name: customerNameDisplay.value,
                    product: document.getElementById('product').value,
                    quantity: document.getElementById('quantity').value,
                    price: document.getElementById('price').value,
                    category: document.getElementById('category').value,
                    account: document.getElementById('account').value,
                    bank_account: document.getElementById('bank_account').value,
                    notes: document.getElementById('notes').value,
                    transaction_type: currentTransactionType,
                    add_another: 'no'
                };

                fetch('/sales/entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=save_sale&${new URLSearchParams(formData).toString()}`
                })
                .then(response => response.json())
                .then(data => {
                    stopLoading();

                    if (data.status === 'success' || data.status === 'add_another') {
                        const quantity = currentTransactionType === 'returned' ?
                            -Math.abs(formData.quantity) : formData.quantity;
                        const newItem = {
                            description: formData.product,
                            quantity: quantity,
                            unitPrice: formData.price,
                            total: (quantity * formData.price).toFixed(2),
                            type: currentTransactionType
                        };
                        currentItems.push(newItem);

                        if (data.pdf_urls){
                            showMultiplePdfLinks(data.pdf_urls);
                            currentInvoiceUrl = data.pdf_urls[0].url;
                        } else{
                            currentInvoiceUrl = data.invoice_url;
                        }

                        // Hide save button and cancel button
                        saveSaleBtn.style.display = 'none';
                        backToTransactionTypeBtn.style.display = 'none';

                        // Show the action buttons section
                        showActionButtons();

                    } else {
                        alert(data.message || 'An error occurred while saving the sale');
                    }
                })
                .catch(error => {
                    stopLoading();
                    console.error('Error saving sale:', error);
                    alert('An error occurred while saving the sale');
                });
            });

            function showActionButtons() {
                // Create action buttons container if it doesn't exist
                let actionButtonsContainer = document.getElementById('actionButtonsContainer');
                if (!actionButtonsContainer) {
                    actionButtonsContainer = document.createElement('div');
                    actionButtonsContainer.id = 'actionButtonsContainer';
                    actionButtonsContainer.className = 'mt-4 d-flex justify-content-end gap-2';

                    // Add buttons (same markup as before)
                    actionButtonsContainer.innerHTML = `
                        <button type="button" class="btn btn-sm btn-primary" id="addItemsBtn">
                            Add Items
                        </button>
                        <button type="button" class="btn btn-sm btn-info" id="viewInvoiceBtn">
                            View
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="downloadInvoiceActionBtn">
                            <i class="bi bi-download me-2"></i>Download Invoice
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" id="finishBtn">
                            Finish
                        </button>
                    `;

                    // Insert after the save button container
                    const saveButtonContainer = document.querySelector('.col-12.mt-3.d-flex.justify-content-end.gap-2');
                    if (saveButtonContainer && saveButtonContainer.parentNode) {
                        saveButtonContainer.parentNode.insertBefore(actionButtonsContainer, saveButtonContainer.nextSibling);
                    } else {
                        // fallback: append to form area
                        document.querySelector('.card-body')?.appendChild(actionButtonsContainer);
                    }

                    // *** Attach listeners ONCE when container is created ***
                    const addItemsBtn = actionButtonsContainer.querySelector('#addItemsBtn');
                    const viewInvoiceBtn = actionButtonsContainer.querySelector('#viewInvoiceBtn');
                    const downloadInvoiceActionBtn = actionButtonsContainer.querySelector('#downloadInvoiceActionBtn');
                    const finishBtn = actionButtonsContainer.querySelector('#finishBtn');

                    addItemsBtn.addEventListener('click', function() {
                        resetFormForNewItem();
                        actionButtonsContainer.style.display = 'none';
                        saveSaleBtn.style.display = 'block';
                        document.getElementById('product').focus();
                    });

                    viewInvoiceBtn.addEventListener('click', function() {
                        // Show the invoice preview
                        updateInvoicePreview(
                            invoiceNumber.value,
                            invDate.value,
                            customerNameDisplay.value,
                            currentTransactionType,
                            currentItems
                        );
                        document.getElementById('invoicePreview').style.display = 'block';
                        actionButtonsContainer.style.display = 'none';
                    });

                    downloadInvoiceActionBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentInvoiceUrl) {
                            const iframe = document.createElement('iframe');
                            iframe.style.display = 'none';
                            iframe.src = currentInvoiceUrl;
                            document.body.appendChild(iframe);
                            // show toast if you have it
                            if (typeof downloadSuccessToast !== 'undefined') {
                                downloadSuccessToast.show();
                            }
                        }
                    });

                    finishBtn.addEventListener('click', function() {
                        resetToClientSearch();
                    });
                }

                // Always make sure it's visible when called
                actionButtonsContainer.style.display = 'flex';
            }


            function showMultiplePdfLinks(pdfUrls){
                const pdfLinksContainer = document.getElementById('pdfLinksContainer');
                pdfLinksContainer.innerHTML = '<h6>Generated Invoices:</h6>';

                pdfUrls.forEach(pdf => {
                    const link = document.createElement('a');
                    link.href = pdf.url;
                    link.className = 'd-block mb-2';
                    link.textContent = `Download ${pdf.date} Invoice`;
                    link.target = '_blank';
                    pdfLinksContainer.appendChild(link);
                });

                pdfLinksContainer.style.display = 'block';
            }

            addAnotherYesBtn.addEventListener('click', function() {
                resetFormForNewItem();
                addAnotherSection.style.display = 'none';
                saveSaleBtn.style.display = 'block';
                document.getElementById('product').focus();
            });
            addAnotherNoBtn.addEventListener('click', function() {
                addAnotherSection.style.display = 'none';

                // Now show the invoice preview
                updateInvoicePreview(
                    invoiceNumber.value,
                    //invoiceDate.value,
                    invDate.value,
                    customerNameDisplay.value,
                    currentTransactionType,
                    currentItems
                );

                document.getElementById('invoicePreview').style.display = 'block';
            });

            function updateInvoicePreview() {
                document.getElementById('previewInvoiceNumber').textContent = invoiceNumber.value;
                //document.getElementById('previewDate').textContent = formatDate(invoiceDate.value);
                document.getElementById('previewDate').textContent = formatDate(invDate.value);
                document.getElementById('previewCustomer').textContent = customerNameDisplay.value;
                document.getElementById('previewTransactionType').textContent =
                    currentTransactionType === 'sell' ? 'Sale' : 'Take Back';

                const invoiceItems = document.getElementById('invoiceItems');
                invoiceItems.innerHTML = '';
                let totalAmount = 0;

                currentItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.description}</td>
                        <td>${Math.abs(item.quantity)}</td>
                        <td>Ksh ${parseFloat(item.unitPrice).toFixed(2)}</td>
                        <td>Ksh ${parseFloat(item.total).toFixed(2)}</td>
                    `;
                    invoiceItems.appendChild(row);
                    totalAmount += parseFloat(item.total);
                });

                document.getElementById('previewTotal').textContent = totalAmount.toFixed(2);
            }

            //downloadInvoiceBtn.addEventListener('click', function(e) {
              //  e.preventDefault();
                //if (currentInvoiceUrl) {
                  //  const iframe = document.createElement('iframe');
                    //iframe.style.display = 'none';
                    //iframe.src = currentInvoiceUrl;
                    //document.body.appendChild(iframe);
                    //downloadSuccessToast.show();

                    // Return to client search instead of exiting
                    //setTimeout(function() {
                      //  resetToClientSearch();
                    //}, 2000);
                //}
            //});

            function formatDate(dateString) {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}-${month}-${year}`;
            }

            function resetFormForNewItem() {
                document.getElementById('product').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('price').value = '';
                document.getElementById('category').value = '';
                document.getElementById('account').value = '';
                document.getElementById('bank_account').value = '';
                document.getElementById('notes').value = '';

                Object.keys(requiredFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const fieldContainer = field.parentNode;
                    const errorElement = fieldContainer.querySelector('.field-error-message');

                    field.classList.remove('field-error', 'field-valid');
                    if (errorElement) {
                        errorElement.classList.remove('show');
                    }
                });
            }

        }

        // Search Functionality for Edit and Receive Sections
        function initializeSearchFunctionality() {
            // Edit section search
            document.getElementById('editSearchBtn').addEventListener('click', function() {
                const editSearchForm = document.getElementById('editSearchForm');
                const detailsModal = document.getElementById('detailsModal');
                const editInvoiceBtn = document.getElementById('editInvoiceBtn');
                const deleteInvoiceBtn = document.getElementById('deleteInvoiceBtn');

                let currentInvoiceId = null;

                // Handle form submission
                editSearchForm.addEventListener('submit', function () {
                    const btn = document.getElementById('editSearchBtn');
                    const text = document.getElementById('editSearchText');
                    const spinner = document.getElementById('editSearchSpinner');

                    btn.disabled = true;
                    text.textContent = 'Loading...';
                    spinner.classList.remove('d-none');
                });
            });

            detailsModal.addEventListener('show.bs.modal', function (event) {
                const clickableRow = event.relatedTarget;
                currentInvoiceId = clickableRow.getAttribute('data-sales-id');

                // Populate details modal
                document.getElementById('detail_invoice_date').textContent = clickableRow.getAttribute('data-invoice-date');
                document.getElementById('detail_invoice_no').textContent = clickableRow.getAttribute('data-invoice-no');
                document.getElementById('detail_customer_name').textContent = clickableRow.getAttribute('data-customer-name');
                document.getElementById('detail_product').textContent = clickableRow.getAttribute('data-product');
                document.getElementById('detail_quantity').textContent = clickableRow.getAttribute('data-quantity');
                document.getElementById('detail_price').textContent = clickableRow.getAttribute('data-price');
                document.getElementById('detail_total').textContent = "Ksh " + parseFloat(clickableRow.getAttribute('data-total')).toLocaleString('en-KE', {minimumFractionDigits: 2});
                document.getElementById('detail_category').textContent = clickableRow.getAttribute('data-category');
                document.getElementById('detail_account_owner').textContent = clickableRow.getAttribute('data-account-owner');
                document.getElementById('detail_bank_account').textContent = clickableRow.getAttribute('data-bank-account');
                document.getElementById('detail_status').textContent = clickableRow.getAttribute('data-status');
            });
            editInvoiceBtn.addEventListener('click', function() {
                // Close details modal
                const detailsModalInstance = bootstrap.Modal.getInstance(detailsModal);
                detailsModalInstance.hide();

                // Open edit modal and populate data
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                const clickableRow = document.querySelector(`.clickable-row[data-sales-id="${currentInvoiceId}"]`);
                // Find the select button that was clicked
                currentInvoiceId = clickableRow.getAttribute('data-sales-id');

                // Populate edit modal
                document.getElementById('modalSalesId').value = currentInvoiceId;
                document.getElementById('modal_invoice_date').value = clickableRow.getAttribute('data-invoice-date');
                document.getElementById('modal_invoice_no').value = clickableRow.getAttribute('data-invoice-no');
                document.getElementById('modal_customer_name').value = clickableRow.getAttribute('data-customer-name');
                document.getElementById('modal_product').value = clickableRow.getAttribute('data-product');
                document.getElementById('modal_quantity').value = clickableRow.getAttribute('data-quantity');
                document.getElementById('modal_price').value = clickableRow.getAttribute('data-price');
                document.getElementById('modal_category').value = clickableRow.getAttribute('data-category');
                document.getElementById('modal_account_owner').value = clickableRow.getAttribute('data-account-owner');
                document.getElementById('modal_bank_account').value = clickableRow.getAttribute('data-bank-account');
                //document.getElementById('modal_status').value = clickableRow.getAttribute('data-status');

                editModal.show();
            });
            document.getElementById('editForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const saveBtn = document.getElementById('saveChangesBtn');
                const saveText = document.getElementById('saveChangesText');
                const spinner = document.getElementById('saveChangesSpinner');

                // Show loading state
                saveBtn.disabled = true;
                saveText.textContent = 'Saving...';
                spinner.classList.remove('d-none');

                const salesId = document.getElementById('modalSalesId').value;
                const formData = new FormData(this);
                const payload = Object.fromEntries(formData.entries());

                // Add sales_id to the payload
                payload.sales_id = salesId;

                fetch(`/edit_sale/${salesId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.status === "success") {
                        alert("Invoice updated successfully!");
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                        // Refresh the page to update the results
                        location.reload();
                    } else {
                        alert("Error: " + (data.message || 'Unknown error occurred'));
                    }
                })
                .catch(error => {
                    console.error('Error updating invoice:', error);
                    alert('Error updating invoice');
                })
                .finally(() => {
                    // Reset button state whether success or failure
                    saveBtn.disabled = false;
                    saveText.textContent = 'Save Changes';
                    spinner.classList.add('d-none');
                });
            });

            // Receive section search
            document.getElementById('receiveSearchBtn').addEventListener('click', function() {
                 const receiveSearchForm = document.getElementById('receiveSearchForm');
                 const receiveDetailsModal = document.getElementById('receiveDetailsModal');
                 const receiveInvoiceBtn = document.getElementById('receiveInvoiceBtn');
                 const deleteSaleBtn = document.getElementById('deleteSaleBtn');

                 let currentInvoiceId = null;


                 // Handle form submission
                receiveSearchForm.addEventListener('submit', function () {
                    const btn = document.getElementById('receiveSearchBtn');
                    const text = document.getElementById('receiveSearchText');
                    const spinner = document.getElementById('receiveSearchSpinner');

                    btn.disabled = true;
                    text.textContent = 'Loading...';
                    spinner.classList.remove('d-none');
                });
            });

            receiveDetailsModal.addEventListener('show.bs.modal', function (event) {
                 const clickableRow = event.relatedTarget;
                 currentInvoiceId = clickableRow.getAttribute('data-sales-list-id');

                // Populate details modal
                document.getElementById('receive_detail_invoice_date').textContent = clickableRow.getAttribute('data-invoice-date');
                document.getElementById('receive_detail_invoice_no').textContent = clickableRow.getAttribute('data-invoice-no');
                document.getElementById('receive_detail_customer_name').textContent = clickableRow.getAttribute('data-customer-name');
                document.getElementById('receive_detail_invoice_amount').textContent = "Ksh " + parseFloat(clickableRow.getAttribute('data-invoice-amount')).toLocaleString('en-KE', {minimumFractionDigits: 2});
                document.getElementById('receive_detail_paid_amount').textContent = "Ksh " + parseFloat(clickableRow.getAttribute('data-paid-amount')).toLocaleString('en-KE', {minimumFractionDigits: 2});
                document.getElementById('receive_detail_balance').textContent = "Ksh " + parseFloat(clickableRow.getAttribute('data-balance')).toLocaleString('en-KE', {minimumFractionDigits: 2});
                document.getElementById('receive_detail_category').textContent = clickableRow.getAttribute('data-category');
                document.getElementById('receive_detail_account_owner').textContent = clickableRow.getAttribute('data-account-owner');
                document.getElementById('receive_detail_status').textContent = clickableRow.getAttribute('data-status');
            });

            // Receive payment functionality
            receiveInvoiceBtn.addEventListener('click', function() {
                // Close details modal
                const receiveDetailsModalInstance = bootstrap.Modal.getInstance(receiveDetailsModal);
                receiveDetailsModalInstance.hide();

                // Open edit modal and populate data
                const receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));

                // Find the row that was clicked
                const clickableRow = document.querySelector(`.clickable-row[data-sales-list-id="${currentInvoiceId}"]`);

                // Populate edit modal
                document.getElementById('modalSalesListId').value = currentInvoiceId;
                document.getElementById('receive_modal_invoice_date').value = clickableRow.getAttribute('data-invoice-date');
                document.getElementById('receive_modal_invoice_no').value = clickableRow.getAttribute('data-invoice-no');
                document.getElementById('receive_modal_customer_name').value = clickableRow.getAttribute('data-customer-name');
                document.getElementById('receive_modal_invoice_amount').value = clickableRow.getAttribute('data-invoice-amount');
                //document.getElementById('receive_modal_total_paid').value = clickableRow.getAttribute('data-paid-amount');
                document.getElementById('receive_modal_payment_now').value = 0;
                document.getElementById('receive_modal_balance').value = clickableRow.getAttribute('data-balance');
                document.getElementById('receive_modal_category').value = clickableRow.getAttribute('data-category');
                document.getElementById('receive_modal_account_owner').value = clickableRow.getAttribute('data-account-owner');
                document.getElementById('receive_modal_status').value = clickableRow.getAttribute('data-status');

                receiveModal.show();
            });

            // Real-time payment validation
            const paymentNowInput = document.getElementById('receive_modal_payment_now');
            paymentNowInput.addEventListener('input', function () {
                const totalPaid = parseFloat(document.getElementById('receive_modal_total_paid').value) || 0;
                const invoiceAmount = parseFloat(document.getElementById('receive_modal_invoice_amount').value) || 0;
                const paymentNow = parseFloat(this.value) || 0;

                const newTotal = totalPaid + paymentNow;
                const remaining = Math.max(0, invoiceAmount - newTotal);

                document.getElementById('remainingBalanceDisplay').textContent =
                    (invoiceAmount - totalPaid).toLocaleString('en-US', { minimumFractionDigits: 2 });

                document.getElementById('receive_modal_balance').value = remaining.toFixed(2);
                document.getElementById('receive_modal_status').value = remaining === 0 ? 'Paid' : 'Not Paid';

                if (newTotal > invoiceAmount) {
                    paymentNowInput.classList.add('is-invalid');
                    document.getElementById('paymentNowError').style.display = 'block';
                } else {
                    paymentNowInput.classList.remove('is-invalid');
                    document.getElementById('paymentNowError').style.display = 'none';
                }
            });

            // Form submission
            document.getElementById('receiveForm').addEventListener('submit', function(e) {
                e.preventDefault();

                document.getElementById('fullPageLoader').style.display = 'flex';
                const btn = document.getElementById('saveReceiveChangesBtn');
                const text = document.getElementById('saveReceiveChangesText');
                const spinner = document.getElementById('saveReceiveChangesSpinner');

                btn.disabled = true;
                text.textContent = 'Saving...';
                spinner.classList.remove('d-none');

                const formData = {
                    sales_list_id: document.getElementById('modalSalesListId').value,
                    invoice_date: document.getElementById('receive_modal_invoice_date').value,
                    invoice_no: document.getElementById('receive_modal_invoice_no').value,
                    customer_name: document.getElementById('receive_modal_customer_name').value,
                    invoice_amount: parseFloat(document.getElementById('receive_modal_invoice_amount').value),
                    payment_now: parseFloat(document.getElementById('receive_modal_payment_now').value), // Key field
                    balance: parseFloat(document.getElementById('receive_modal_balance').value),
                    category: document.getElementById('receive_modal_category').value,
                    account_owner: document.getElementById('receive_modal_account_owner').value,
                    status: document.getElementById('receive_modal_status').value
                };

                const salesListId = document.getElementById('modalSalesListId').value;

                fetch(`/record_payment/${salesListId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Create success message with download button
                        const successMessage = `
                            ${data.message}
                            <button onclick="downloadAndRefresh('${data.download_url}')"
                                    class="btn btn-sm btn-success ms-2">
                                <i class="bi bi-download"></i> Download Receipt
                            </button>
                        `;

                        // Create and show Bootstrap alert
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.role = 'alert';
                        alertDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>${successMessage}</div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;

                        // Insert the alert at the top of the container
                        const container = document.querySelector('.main-container');
                        container.insertBefore(alertDiv, container.firstChild);

                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('receiveModal'));
                        modal.hide();

                        // Hide the full page loader
                        document.getElementById('fullPageLoader').style.display = 'none';
                    } else {
                        showErrorAlert(data.message || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorAlert(error.message || 'An error occurred while saving changes');
                })
                .finally(() => {
                    btn.disabled = false;
                    text.textContent = 'Save Changes';
                    spinner.classList.add('d-none');
                    document.getElementById('fullPageLoader').style.display = 'none';
                });
            });

            // Helper function to show error alerts
            function showErrorAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                const container = document.querySelector('.main-container');
                container.insertBefore(alertDiv, container.firstChild);
            }

            // Download and refresh function
            function downloadAndRefresh(downloadUrl) {
                // Download the receipt
                window.open(downloadUrl, '_blank');

                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }


            // Optional: Add event listener for download buttons if they exist on page load
            document.querySelectorAll('.download-receipt-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const receiptUrl = this.getAttribute('data-receipt-url');
                    window.open(receiptUrl, '_blank');
                });
            });
// MPESA Payment Functionality
const mpesaInvoiceBtn = document.getElementById('mpesaInvoiceBtn');
const mpesaModal = new bootstrap.Modal(document.getElementById('mpesaModal'));
const mpesaPaymentForm = document.getElementById('mpesaPaymentForm');
const initiateStkPush = document.getElementById('initiateStkPush');

let currentMpesaModal = null;

// Open MPESA modal
mpesaInvoiceBtn.addEventListener('click', function() {
    // Close details modal
    const receiveDetailsModalInstance = bootstrap.Modal.getInstance(receiveDetailsModal);
    receiveDetailsModalInstance.hide();

    // Find the row that was clicked
    const clickableRow = document.querySelector(`.clickable-row[data-sales-list-id="${currentInvoiceId}"]`);

    // Populate MPESA modal
    const balance = parseFloat(clickableRow.getAttribute('data-balance'));
    const invoiceNo = clickableRow.getAttribute('data-invoice-no');
    const customerName = clickableRow.getAttribute('data-customer-name');

    document.getElementById('mpesaSalesListId').value = currentInvoiceId;
    document.getElementById('mpesaInvoiceNo').value = invoiceNo;
    document.getElementById('mpesaCustomerName').value = customerName;
    document.getElementById('mpesaBalance').value = balance;
    document.getElementById('description').value = `Payment for invoice ${invoiceNo}`;

    // Reset form and messages
    mpesaPaymentForm.reset();
    document.getElementById('amount').value = ''; // Clear amount field
    hideMpesaResponse();

    // Store the modal instance
    currentMpesaModal = new bootstrap.Modal(document.getElementById('mpesaModal'));
    currentMpesaModal.show();
});

// Real-time amount validation
document.getElementById('amount').addEventListener('input', function() {
    const amount = parseFloat(this.value) || 0;

    if (amount <= 0) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// MPESA form submission
mpesaPaymentForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const amount = parseFloat(document.getElementById('amount').value);

    if (amount <= 0) {
        showMpesaResponse('Amount must be greater than 0', 'error');
        return;
    }

    initiateStkPushPayment();
});

function initiateStkPushPayment() {
    const btn = document.getElementById('initiateStkPush');
    const text = document.getElementById('stkPushText');
    const spinner = document.getElementById('stkPushSpinner');

    // Show loading state
    btn.disabled = true;
    text.textContent = 'Processing...';
    spinner.classList.remove('d-none');
    hideMpesaResponse();

    const formData = {
        sales_list_id: document.getElementById('mpesaSalesListId').value,
        invoice_no: document.getElementById('mpesaInvoiceNo').value,
        customer_name: document.getElementById('mpesaCustomerName').value,
        phone_number: document.getElementById('phoneNumber').value,
        amount: document.getElementById('amount').value,
        description: document.getElementById('description').value
    };

    fetch('/initiate_mpesa_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMpesaResponse(
                'Please check your phone to complete the payment. ',
                'success'
            );

            // Disable form inputs
            disableMpesaForm();

            // Start polling for payment status
            pollForPaymentStatus(data.checkout_request_id);

        } else {
            showMpesaResponse(data.message || 'Payment initiation failed', 'error');
            // Re-enable button on error
            resetMpesaButton();
        }
    })
    .catch(error => {
        console.error('Error initiating MPESA payment:', error);
        showMpesaResponse('Network error. Please try again.', 'error');
        resetMpesaButton();
    });
}

function pollForPaymentStatus(checkoutRequestId) {
    let attempts = 0;
    const maxAttempts = 60; // 5 minutes

    const checkStatus = setInterval(() => {
        attempts++;

        fetch('/check_mpesa_status?checkout_request_id=' + encodeURIComponent(checkoutRequestId))
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Payment status check (attempt ${attempts}):`, data);

                if (data.status === 'Completed') {
                    clearInterval(checkStatus);
                    showMpesaResponse(
                        `✓ Payment confirmed successfully!<br>
                         Receipt: ${data.mpesa_receipt || 'N/A'}<br>
                         Amount: Ksh ${parseFloat(data.amount).toLocaleString()}<br>
                         <strong>Closing in 3 seconds...</strong>`,
                        'success'
                    );

                    setTimeout(() => {
                        if (currentMpesaModal) {
                            currentMpesaModal.hide();
                        }
                        location.reload();
                    }, 3000);

                } else if (data.status === 'Failed') {
                    clearInterval(checkStatus);
                    showMpesaResponse(
                        `✗ Payment failed: ${data.result_desc || 'Transaction was not completed'}`,
                        'danger'
                    );
                    enableMpesaForm();
                    resetMpesaButton();

                } else if (data.status === 'Pending' && attempts < maxAttempts) {
                    // Still pending
                    showMpesaResponse(
                        `<div class="spinner-border spinner-border-sm me-2" role="status"></div>
                         Waiting for payment confirmation... (${attempts}/${maxAttempts})`,
                        'info'
                    );

                } else if (attempts >= maxAttempts) {
                    clearInterval(checkStatus);
                    showMpesaResponse(
                        '⚠ Payment status check timeout.<br>The payment may still be processing.<br>Please check your MPESA messages and refresh the page.',
                        'warning'
                    );
                    enableMpesaForm();
                    resetMpesaButton();
                }
            })
            .catch(error => {
                console.error('Error checking payment status:', error);
                if (attempts >= maxAttempts) {
                    clearInterval(checkStatus);
                    showMpesaResponse(
                        '⚠ Unable to verify payment status.<br>Please check your MPESA messages and refresh the page.',
                        'warning'
                    );
                    enableMpesaForm();
                    resetMpesaButton();
                }
            });
    }, 5000); // Check every 5 seconds
}

function disableMpesaForm() {
    document.getElementById('phoneNumber').disabled = true;
    document.getElementById('amount').disabled = true;
    document.getElementById('initiateStkPush').disabled = true;
}

function enableMpesaForm() {
    document.getElementById('phoneNumber').disabled = false;
    document.getElementById('amount').disabled = false;
    document.getElementById('initiateStkPush').disabled = false;
}

function resetMpesaButton() {
    const btn = document.getElementById('initiateStkPush');
    const text = document.getElementById('stkPushText');
    const spinner = document.getElementById('stkPushSpinner');

    btn.disabled = false;
    text.textContent = 'Initiate Payment';
    spinner.classList.add('d-none');
}

function showMpesaResponse(message, type) {
    const responseDiv = document.getElementById('mpesaResponse');
    responseDiv.innerHTML = message;
    responseDiv.className = `alert alert-${type} d-block`;
}

function hideMpesaResponse() {
    const responseDiv = document.getElementById('mpesaResponse');
    responseDiv.className = 'alert d-none';
}

// Close modal handler to reset form if user manually closes
document.getElementById('mpesaModal').addEventListener('hidden.bs.modal', function () {
    enableMpesaForm();
    resetMpesaButton();
    hideMpesaResponse();
});
        }

        function downloadAndRefresh(downloadUrl) {
                // Create a hidden iframe for download
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = downloadUrl;
                document.body.appendChild(iframe);

                // Wait for download to initiate
                iframe.onload = function() {
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        window.location.reload();
                    }, 1000);
                };

                // Fallback
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                    window.location.reload();
                }, 3000);
        }

    </script>

</body>
</html>